<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตั้งค่าการยืนยันตัวตน 2 ขั้นตอน - NudDee</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .qr-container {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
        }
        .qr-code {
            max-width: 250px;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            padding: 10px;
        }
        .secret-key {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
            margin: 15px 0;
        }
        .step-card {
            border: 1px solid #e3e6f0;
            border-radius: 10px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .step-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .step-number {
            background: linear-gradient(45deg, #4e73df, #224abe);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        .app-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .app-item {
            text-align: center;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .app-item:hover {
            background: #f8f9fa;
            border-color: #4e73df;
        }
        .app-icon {
            font-size: 30px;
            margin-bottom: 10px;
            color: #5a5c69;
        }
        .verification-form {
            background: #fff;
            border: 1px solid #e3e6f0;
            border-radius: 10px;
            padding: 30px;
            margin-top: 30px;
        }
        .code-input {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            text-align: center;
            letter-spacing: 5px;
        }
        .btn-setup {
            background: linear-gradient(45deg, #4e73df, #224abe);
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
        }
        .btn-setup:hover {
            background: linear-gradient(45deg, #224abe, #1e3a8a);
            color: white;
        }
        .security-badge {
            background: linear-gradient(45deg, #1cc88a, #17a2b8);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            margin-bottom: 20px;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <div class="container mt-5 p-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Header -->
                <div class="text-center mb-4">
                    <h1 class="h3 text-gray-900 mb-2">
                        <i class="fas fa-shield-alt text-success me-2"></i>
                        ตั้งค่าการยืนยันตัวตน 2 ขั้นตอน
                    </h1>
                    <p class="text-muted">เพิ่มความปลอดภัยให้กับบัญชีของคุณด้วย Google Authenticator หรือแอปที่รองรับ TOTP</p>
                    <span class="security-badge">
                        <i class="fas fa-lock me-1"></i>
                        ความปลอดภัยระดับสูง
                    </span>
                </div>

                <!-- Step 1: Download App -->
                <div class="step-card">
                    <div class="card-body">
                        <div class="d-flex align-items-start">
                            <div class="step-number">1</div>
                            <div class="flex-grow-1">
                                <h5 class="mb-3">ดาวน์โหลดแอปยืนยันตัวตน</h5>
                                <p class="text-muted mb-3">เลือกแอปที่คุณต้องการใช้งาน:</p>
                                
                                <div class="app-list">
                                    <div class="app-item">
                                        <div class="app-icon">
                                            <i class="fab fa-google"></i>
                                        </div>
                                        <div class="fw-bold">Google Authenticator</div>
                                        <small class="text-muted">แนะนำ</small>
                                    </div>
                                    <div class="app-item">
                                        <div class="app-icon">
                                            <i class="fas fa-mobile-alt"></i>
                                        </div>
                                        <div class="fw-bold">Microsoft Authenticator</div>
                                    </div>
                                    <div class="app-item">
                                        <div class="app-icon">
                                            <i class="fas fa-key"></i>
                                        </div>
                                        <div class="fw-bold">Authy</div>
                                    </div>
                                    <div class="app-item">
                                        <div class="app-icon">
                                            <i class="fas fa-shield-alt"></i>
                                        </div>
                                        <div class="fw-bold">1Password</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Scan QR Code -->
                <div class="step-card">
                    <div class="card-body">
                        <div class="d-flex align-items-start">
                            <div class="step-number">2</div>
                            <div class="flex-grow-1">
                                <h5 class="mb-3">สแกน QR Code</h5>
                                <p class="text-muted mb-3">ใช้แอปยืนยันตัวตนสแกน QR Code ด้านล่าง:</p>
                                
                                <div class="qr-container">
                                    <img src="data:image/png;base64,{{ qr_code }}" alt="QR Code" class="qr-code mb-3">
                                    <div class="text-muted">
                                        <i class="fas fa-qrcode me-2"></i>
                                        สแกน QR Code นี้ด้วยแอปยืนยันตัวตน
                                    </div>
                                </div>

                                <!-- Manual Entry Option -->
                                <div class="mt-4">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#manualEntry" aria-expanded="false">
                                        <i class="fas fa-keyboard me-2"></i>
                                        หรือกรอกรหัสด้วยตนเอง
                                    </button>
                                    
                                    <div class="collapse mt-3" id="manualEntry">
                                        <div class="alert alert-info">
                                            <strong>รหัสลับ (Secret Key):</strong>
                                            <div class="secret-key">{{ secret }}</div>
                                            <small class="text-muted">
                                                คัดลอกรหัสนี้และใส่ในแอปยืนยันตัวตนของคุณ
                                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="copySecret()">
                                                    <i class="fas fa-copy"></i> คัดลอก
                                                </button>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Verify -->
                <div class="step-card">
                    <div class="card-body">
                        <div class="d-flex align-items-start">
                            <div class="step-number">3</div>
                            <div class="flex-grow-1">
                                <h5 class="mb-3">ยืนยันการตั้งค่า</h5>
                                <p class="text-muted mb-3">กรอกรหัส 6 หลักจากแอปยืนยันตัวตนเพื่อยืนยันการตั้งค่า:</p>
                                
                                <!-- Verification Form -->
                                <div class="verification-form">
                                    <form method="POST" id="verify2FAForm">
                                        {% if csrf_token %}
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        {% endif %}
                                        <div class="row">
                                            <div class="col-md-8 mx-auto">
                                                <div class="mb-3">
                                                    <label for="verification_code" class="form-label fw-bold">รหัสยืนยัน 6 หลัก</label>
                                                    <input type="text" 
                                                           class="form-control form-control-lg code-input" 
                                                           id="verification_code" 
                                                           name="verification_code" 
                                                           placeholder="000000"
                                                           maxlength="6"
                                                           pattern="[0-9]{6}"
                                                           required>
                                                    <div class="form-text">
                                                        <i class="fas fa-info-circle me-1"></i>
                                                        รหัสจะเปลี่ยนทุก 30 วินาที
                                                    </div>
                                                </div>
                                                
                                                <div class="d-grid gap-2">
                                                    <button type="submit" class="btn btn-setup btn-lg" id="submitBtn">
                                                        <i class="fas fa-shield-alt me-2"></i>
                                                        เปิดใช้งาน 2FA
                                                    </button>
                                                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                                                        <i class="fas fa-arrow-left me-2"></i>
                                                        ข้ามขั้นตอนนี้
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Tips -->
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>ข้อแนะนำด้านความปลอดภัย</h6>
                    <ul class="mb-0 small">
                        <li>เก็บรหัสลับ (Secret Key) ไว้ในที่ปลอดภัย กรณีที่ต้องการย้ายอุปกรณ์</li>
                        <li>อย่าแชร์รหัสยืนยัน 6 หลักกับใครที่ไม่ใช่ตัวคุณเอง</li>
                        <li>หากสูญหายอุปกรณ์ ให้ติดต่อผู้ดูแลระบบทันที</li>
                        <li>ควรมีแอปยืนยันตัวตนในอุปกรณ์สำรองอย่างน้อย 1 เครื่อง</li>
                    </ul>
                </div>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Additional Information -->
                <div class="mt-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>ข้อมูลเพิ่มเติม</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>ขั้นตอนการตั้งค่า:</h6>
                                    <ol class="small">
                                        <li>ดาวน์โหลดแอป Authenticator</li>
                                        <li>สแกน QR Code หรือกรอกรหัสลับ</li>
                                        <li>กรอกรหัส 6 หลักเพื่อยืนยัน</li>
                                        <li>เสร็จสิ้นการตั้งค่า</li>
                                    </ol>
                                </div>
                                <div class="col-md-6">
                                    <h6>ประโยชน์ของ 2FA:</h6>
                                    <ul class="small">
                                        <li>ป้องกันการเข้าถึงโดยไม่ได้รับอนุญาต</li>
                                        <li>เพิ่มความปลอดภัยให้กับข้อมูลผู้ป่วย</li>
                                        <li>ลดความเสี่ยงจากการโจรกรรมรหัสผ่าน</li>
                                        <li>ตรงตามมาตรฐานความปลอดภัย</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Back to Dashboard -->
                <div class="text-center mt-4">
                    <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                        <i class="fas fa-home me-2"></i>
                        กลับสู่หน้าหลัก
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-format verification code input
        document.getElementById('verification_code').addEventListener('input', function(e) {
            // Only allow numbers
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
            
            // Auto-submit when 6 digits are entered
            if (e.target.value.length === 6) {
                // Add small delay to allow user to see the complete code
                setTimeout(() => {
                    document.getElementById('verify2FAForm').submit();
                }, 500);
            }
        });

        // Copy secret key function
        function copySecret() {
            const secretText = '{{ secret }}';
            navigator.clipboard.writeText(secretText).then(function() {
                // Show success message
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> คัดลอกแล้ว';
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-success');
                
                setTimeout(function() {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-primary');
                }, 2000);
            }).catch(function(err) {
                alert('ไม่สามารถคัดลอกได้: ' + err);
            });
        }

        // Form submission handling
        document.getElementById('verify2FAForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalHTML = submitBtn.innerHTML;
            const verificationCode = document.getElementById('verification_code').value;
            
            // Validate code
            if (!/^[0-9]{6}$/.test(verificationCode)) {
                alert('กรุณากรอกรหัส 6 หลัก');
                return;
            }
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>กำลังยืนยัน...';
            
            // Prepare form data
            const formData = new FormData();
            formData.append('verification_code', verificationCode);
            
            // Add CSRF token if available
            const csrfToken = document.querySelector('input[name="csrf_token"]');
            if (csrfToken) {
                formData.append('csrf_token', csrfToken.value);
            }
            
            // Submit form
            fetch(window.location.href, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.headers.get('content-type')?.includes('application/json')) {
                    return response.json();
                } else {
                    // If not JSON, assume it's a redirect or HTML response
                    if (response.ok) {
                        return { success: true };
                    } else {
                        throw new Error('เกิดข้อผิดพลาดในการตั้งค่า 2FA');
                    }
                }
            })
            .then(data => {
                if (data.success) {
                    // Success - show success message and redirect
                    submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>เปิดใช้งานสำเร็จ!';
                    submitBtn.classList.remove('btn-setup');
                    submitBtn.classList.add('btn-success');
                    
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                    alertDiv.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        ตั้งค่าการยืนยันตัวตน 2 ขั้นตอนสำเร็จ! กำลังนำคุณกลับสู่หน้าหลัก...
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.querySelector('.verification-form').appendChild(alertDiv);
                    
                    setTimeout(() => {
                        window.location.href = '{{ url_for("index") }}';
                    }, 2000);
                } else {
                    // Error - show error message
                    const errorMsg = data.error || 'เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง';
                    
                    // Show error alert
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
                    alertDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${errorMsg}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.querySelector('.verification-form').appendChild(alertDiv);
                    
                    // Reset button state
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHTML;
                    
                    // Clear and focus input
                    document.getElementById('verification_code').value = '';
                    document.getElementById('verification_code').focus();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Show error alert
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาลองใหม่อีกครั้ง
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.verification-form').appendChild(alertDiv);
                
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHTML;
            });
        });

        // Auto-focus on verification code input
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('verification_code').focus();
        });

        // Countdown timer for code refresh (visual indicator)
        function startCountdown() {
            let seconds = 30;
            const timer = setInterval(() => {
                const formText = document.querySelector('.form-text');
                if (formText) {
                    formText.innerHTML = `<i class="fas fa-clock me-1"></i>รหัสจะเปลี่ยนใน ${seconds} วินาที`;
                }
                
                seconds--;
                if (seconds < 0) {
                    seconds = 30;
                    if (formText) {
                        formText.innerHTML = '<i class="fas fa-sync-alt me-1"></i>รหัสใหม่พร้อมใช้งาน';
                        setTimeout(() => {
                            formText.innerHTML = '<i class="fas fa-info-circle me-1"></i>รหัสจะเปลี่ยนทุก 30 วินาที';
                        }, 2000);
                    }
                }
            }, 1000);
        }

        // Start countdown when page loads
        document.addEventListener('DOMContentLoaded', startCountdown);

        // Add smooth animations
        document.addEventListener('DOMContentLoaded', function() {
            // Animate step cards on scroll
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, observerOptions);

            // Observe all step cards
            document.querySelectorAll('.step-card').forEach(card => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                observer.observe(card);
            });
        });
    </script>
</body>
</html>