<!-- templates/booking/reschedule.html - Flask-first approach -->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เลื่อนนัดหมาย - {{ booking.booking_reference }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        /* Same styles as select_time.html */
        .calendar-day {
            transition: all 0.2s ease;
        }
        .calendar-day.available:hover:not(.selected) {
            background-color: #e0e7ff;
            transform: scale(1.05);
        }
        .calendar-day.selected {
            background-color: #6366f1;
            color: white;
        }
        .time-slot {
            transition: all 0.2s ease;
        }
        .time-slot:hover {
            transform: scale(1.05);
        }
        .time-slot.selected {
            background-color: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen">
    
    <!-- Header - Same as select_time.html -->
    <div class="bg-white shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-6">
            <div class="flex items-center space-x-4">
                <a href="{{ url_for('booking.manage_booking', reference=booking.booking_reference, subdomain=subdomain) }}" 
                   class="text-gray-600 hover:text-gray-900">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">เลื่อนนัดหมาย</h1>
                    <p class="text-gray-600">{{ booking.event_type.name }} ({{ booking.event_type.duration_minutes }} นาที)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Booking Info Bar -->
    <div class="bg-yellow-50 border-b border-yellow-200">
        <div class="max-w-6xl mx-auto px-4 py-3">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-sm text-yellow-800">
                    นัดหมายเดิม: <strong>{{ booking.appointment_datetime|thai_date }}</strong> เวลา <strong>{{ booking.appointment_datetime|thai_time }} น.</strong>
                    | รหัส: <strong>{{ booking.booking_reference }}</strong>
                </span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4 py-8">
        <form method="POST" action="{{ url_for('booking.reschedule_booking', reference=booking.booking_reference, subdomain=subdomain) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="new_date" id="selected-date">
            <input type="hidden" name="new_time" id="selected-time">
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- Calendar Section -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">เลือกวันที่ใหม่</h2>
                    
                    <!-- Month Navigation -->
                    <div class="flex justify-between items-center mb-4">
                        <button type="button" onclick="changeMonth(-1)" 
                                id="prev-month-btn"
                                class="p-2 hover:bg-gray-100 rounded-lg"
                                {% if not calendar_data.can_go_previous %}disabled style="opacity: 0.3; cursor: not-allowed;"{% endif %}>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h3 class="text-lg font-medium" id="current-month">
                            {{ calendar_data.month_name }} {{ calendar_data.year + 543 }}
                        </h3>
                        <button type="button" onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 gap-1 mb-2">
                        {% for day in ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'] %}
                        <div class="text-center text-sm font-medium text-gray-500 py-2">{{ day }}</div>
                        {% endfor %}
                    </div>
                    
                    <div class="grid grid-cols-7 gap-1" id="calendar-grid">
                        {% for week in calendar_data.weeks %}
                            {% for day_info in week %}
                                {% if day_info.day == 0 %}
                                    <div class="p-3"></div>
                                {% else %}
                                    <div class="calendar-day p-3 text-center rounded-lg 
                                               {% if day_info.past %}text-gray-300 cursor-not-allowed{% endif %}
                                               {% if day_info.today %}border-2 border-purple-400{% endif %}
                                               {% if day_info.available and not day_info.past %}hover:bg-gray-100 cursor-pointer{% endif %}
                                               {% if not day_info.available and not day_info.past %}text-gray-400 bg-gray-50{% endif %}"
                                         data-date="{{ day_info.date }}"
                                         {% if day_info.available and not day_info.past %}onclick="selectDate(this)"{% endif %}>
                                        {{ day_info.day }}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Time Slots Section -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">เลือกเวลาใหม่</h2>
                    
                    <div id="selected-date-display" class="mb-4 p-3 bg-purple-50 rounded-lg hidden">
                        <span class="text-purple-700 font-medium"></span>
                    </div>
                    
                    <div id="time-slots-container">
                        <div class="text-center py-12 text-gray-400">
                            <svg class="w-16 h-16 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" 
                                      d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <p>กรุณาเลือกวันที่ก่อน</p>
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="loading-slots" class="hidden">
                        <div class="flex justify-center items-center py-12">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reason Section -->
            <div class="mt-8 bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">เหตุผลในการเลื่อน (ถ้ามี)</h3>
                <textarea name="reason" rows="2" 
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                          placeholder="ระบุเหตุผล..."></textarea>
            </div>
            
            <!-- Continue Button -->
            <div class="mt-8 flex justify-end gap-4">
                <a href="{{ url_for('booking.manage_booking', reference=booking.booking_reference, subdomain=subdomain) }}"
                   class="px-8 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    ยกเลิก
                </a>
                <button type="submit" id="continue-btn" disabled
                        class="px-8 py-3 bg-gray-300 text-white rounded-lg font-medium cursor-not-allowed transition-all">
                    ยืนยันการเลื่อน
                </button>
            </div>
        </form>
    </div>

    <script>
        let selectedDate = null;
        let selectedTime = null;
        let currentMonth = {{ calendar_data.month }};
        let currentYear = {{ calendar_data.year }};
        const eventTypeId = {{ booking.event_type.id }};
        const subdomain = '{{ subdomain }}';
        const today = '{{ today }}';
        const availabilitySchedule = {{ calendar_data.availability_schedule|tojson }};
        
        function selectDate(element) {
            const date = element.dataset.date;
            
            // Update UI
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });
            element.classList.add('selected');
            
            selectedDate = date;
            selectedTime = null;
            
            // Update hidden input
            document.getElementById('selected-date').value = date;
            
            // Update selected date display
            const dateObj = new Date(date + 'T00:00:00');
            const dayNames = ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัส', 'ศุกร์', 'เสาร์'];
            const monthNames = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 
                              'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
            
            const displayText = `${dayNames[dateObj.getDay()]} ${dateObj.getDate()} ${monthNames[dateObj.getMonth()]} ${dateObj.getFullYear() + 543}`;
            
            const displayDiv = document.getElementById('selected-date-display');
            displayDiv.classList.remove('hidden');
            displayDiv.querySelector('span').textContent = displayText;
            
            // Load available time slots
            loadTimeSlots(date);
        }
        
        async function loadTimeSlots(date) {
            const container = document.getElementById('time-slots-container');
            const loading = document.getElementById('loading-slots');
            
            // Show loading
            container.style.display = 'none';
            loading.classList.remove('hidden');
            
            try {
                // Call FastAPI through Flask proxy
                const response = await fetch(`/book/api/availability/${eventTypeId}/${date}?subdomain=${subdomain}`);
                const data = await response.json();
                
                if (data.slots && data.slots.length > 0) {
                    let slotsHtml = '<div class="grid grid-cols-3 gap-2">';
                    
                    data.slots.forEach(slot => {
                        if (slot.available) {
                            slotsHtml += `
                                <button type="button" 
                                        class="time-slot p-2 border-2 border-gray-200 rounded-lg hover:border-purple-400"
                                        onclick="selectTime('${slot.time}', this)">
                                    ${slot.time}
                                </button>
                            `;
                        }
                    });
                    
                    slotsHtml += '</div>';
                    container.innerHTML = slotsHtml;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 12h.01M12 12h.01M12 12h-.01M12 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p>ไม่มีเวลาว่างในวันนี้</p>
                            <p class="text-sm mt-1">กรุณาเลือกวันอื่น</p>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = '<div class="text-center py-8 text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูล</div>';
            } finally {
                loading.classList.add('hidden');
                container.style.display = 'block';
            }
        }
        
        function selectTime(time, element) {
            // Update UI
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            element.classList.add('selected');
            
            selectedTime = time;
            
            // Update form
            document.getElementById('selected-time').value = time;
            
            // Enable continue button
            const btn = document.getElementById('continue-btn');
            btn.disabled = false;
            btn.classList.remove('bg-gray-300', 'cursor-not-allowed');
            btn.classList.add('bg-gradient-to-r', 'from-purple-600', 'to-blue-600', 'hover:from-purple-700', 'hover:to-blue-700');
        }
        
        async function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            } else if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            
            // Load new calendar via AJAX
            try {
                const response = await fetch(`/book/api/calendar/${currentYear}/${currentMonth}?event_type_id=${eventTypeId}&subdomain=${subdomain}`);
                const data = await response.json();
                
                // Update month display
                document.getElementById('current-month').textContent = 
                    `${data.month_name} ${data.year + 543}`;
                
                // Update calendar grid
                renderCalendarGrid(data);
                
                // Update prev button state
                const prevBtn = document.getElementById('prev-month-btn');
                if (!data.can_go_previous) {
                    prevBtn.disabled = true;
                    prevBtn.style.opacity = '0.3';
                    prevBtn.style.cursor = 'not-allowed';
                } else {
                    prevBtn.disabled = false;
                    prevBtn.style.opacity = '1';
                    prevBtn.style.cursor = 'pointer';
                }
                
            } catch (error) {
                console.error('Error loading calendar:', error);
            }
        }
        
        function renderCalendarGrid(calendarData) {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            calendarData.weeks.forEach(week => {
                week.forEach(dayInfo => {
                    if (dayInfo.day === 0) {
                        grid.innerHTML += '<div class="p-3"></div>';
                    } else {
                        let classes = 'calendar-day p-3 text-center rounded-lg';
                        let onclick = '';
                        
                        if (dayInfo.past) {
                            classes += ' text-gray-300 cursor-not-allowed';
                        } else if (dayInfo.available) {
                            classes += ' hover:bg-gray-100 cursor-pointer';
                            onclick = `onclick="selectDate(this)"`;
                        } else {
                            classes += ' text-gray-400 bg-gray-50';
                        }
                        
                        if (dayInfo.today) {
                            classes += ' border-2 border-purple-400';
                        }
                        
                        grid.innerHTML += `
                            <div class="${classes}"
                                 data-date="${dayInfo.date}"
                                 ${onclick}>
                                ${dayInfo.day}
                            </div>
                        `;
                    }
                });
            });
        }
    </script>
</body>
</html>