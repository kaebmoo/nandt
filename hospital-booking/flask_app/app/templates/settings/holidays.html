<!-- templates/settings/holidays.html -->
{% extends "base.html" %}

{% block title %}‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î - NudDee{% endblock %}

{% block extra_css %}
<style>
    body { font-family: 'Sarabun', sans-serif; }
    .holiday-card {
        transition: all 0.2s ease;
    }
    .holiday-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .source-badge {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 9999px;
    }
    .source-ical { background-color: #dbeafe; color: #1e40af; }
    .source-manual { background-color: #f3e8ff; color: #6b21a8; }
    .source-custom { background-color: #fef3c7; color: #92400e; }
    
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 24px;
    }
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #cbd5e1;
        transition: .4s;
        border-radius: 24px;
    }
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    input:checked + .toggle-slider {
        background-color: #10b981;
    }
    input:checked + .toggle-slider:before {
        transform: translateX(24px);
    }
</style>
{% endblock %}

{% block content %}

<!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-4">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} {% if category == 'error' %}bg-red-100 border border-red-400 text-red-700{% elif category == 'info' %}bg-blue-100 border border-blue-400 text-blue-700{% else %}bg-green-100 border border-green-400 text-green-700{% endif %} px-4 py-3 rounded relative mb-4">
                        {{ message }}
                        <button onclick="this.parentElement.style.display='none'" class="absolute top-0 bottom-0 right-0 px-4 py-3">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    
    <!-- Header -->
    <div class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</h1>
                <p class="mt-2 text-gray-600">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</p>
            </div>
            <div class="flex items-center space-x-3">
                <!-- Year Selector -->
                <select id="yearSelect" onchange="changeYear()" 
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    
                    {% for year in range(current_year - 1, current_year + 3) %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>
                            ‡∏û.‡∏®. {{ year + 543 }}
                        </option>
                    {% endfor %}
                </select>
                
                <!-- Sync Button -->
                <button onclick="showSyncModal()" 
                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                    <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£
                </button>
                
                <!-- Add Custom Holiday Button -->
                <button onclick="showAddModal()" 
                        class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                    <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white rounded-lg shadow-sm border p-4">
            <div class="text-2xl font-bold text-gray-900">{{ holidays|length }}</div>
            <div class="text-sm text-gray-600">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border p-4">
            <div class="text-2xl font-bold text-green-600">
                {{ holidays|selectattr('is_active', 'equalto', true)|list|length }}
            </div>
            <div class="text-sm text-gray-600">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border p-4">
            <div class="text-2xl font-bold text-blue-600">
                {{ holidays|selectattr('source', 'equalto', 'iCal_th')|list|length }}
            </div>
            <div class="text-sm text-gray-600">‡∏à‡∏≤‡∏Å‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô iCal</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border p-4">
            <div class="text-2xl font-bold text-purple-600">
                {{ holidays|selectattr('source', 'equalto', 'manual')|list|length }}
            </div>
            <div class="text-sm text-gray-600">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</div>
        </div>
    </div>

    <!-- Holidays List -->
    <div class="bg-white rounded-xl shadow-sm border">
        <div class="p-6 border-b">
            <h2 class="text-lg font-semibold text-gray-900">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</h2>
        </div>
        
        {% if holidays %}
        <div class="divide-y">
            {% for holiday in holidays|sort(attribute='date') %}
            <div class="holiday-card p-4 hover:bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <!-- Date Display -->
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-900">
                                {{ holiday.date.strftime('%-d') }}
                            </div>
                            <div class="text-sm text-gray-600">
                                {{ ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', 
                                   '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'][holiday.date.month - 1] }}
                            </div>
                        </div>
                        
                        <!-- Holiday Info -->
                        <div class="flex-1">
                            <div class="flex items-center space-x-2">
                                <h3 class="font-medium text-gray-900">{{ holiday.name }}</h3>
                                <span class="source-badge source-{{ holiday.source|lower|replace('_', '-') }}">
                                    {% if holiday.source == 'iCal_th' %}
                                        üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
                                    {% elif holiday.source == 'manual' %}
                                        ‚úèÔ∏è ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á
                                    {% else %}
                                        üîß {{ holiday.source }}
                                    {% endif %}
                                </span>
                            </div>
                            {% if holiday.description %}
                            <p class="text-sm text-gray-600 mt-1">{{ holiday.description }}</p>
                            {% endif %}
                            <div class="text-xs text-gray-500 mt-1">
                                ‡∏ß‡∏±‡∏ô{{ ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'][holiday.date.weekday()] }}
                                ‡∏ó‡∏µ‡πà {{ holiday.date | thai_date }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex items-center space-x-3">
                    <!-- Active Toggle -->
                    <label class="toggle-switch">
                        <input type="checkbox" 
                            {% if holiday.is_active %}checked{% endif %}
                            data-toggle-url="{{ url('holidays.toggle_holiday', holiday_id=holiday.id) }}"
                            onchange="toggleHoliday(this)">
                        <span class="toggle-slider"></span>
                    </label>
                    
                    <!-- Delete Button (for manual holidays only) -->
                    {% if holiday.source == 'manual' %}
                    <button onclick="deleteHoliday(this)" 
                            data-delete-url="{{ url('holidays.delete_holiday', holiday_id=holiday.id) }}"
                            class="p-1 text-gray-400 hover:text-red-600 transition-colors"
                            title="‡∏•‡∏ö">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                    {% endif %}
                </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Empty State -->
        <div class="p-12 text-center">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" 
                      d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</h3>
            <p class="text-sm text-gray-500 mb-4">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏≠‡∏á</p>
            <div class="flex justify-center space-x-3">
                <button onclick="showSyncModal()" 
                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£
                </button>
                <button onclick="showAddModal()" 
                        class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏≠‡∏á
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Sync Modal -->
<div id="syncModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</h2>
        <p class="text-gray-600 mb-6">
            ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏à‡∏≤‡∏Å‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô iCloud ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        </p>
        
        <form id="syncForm" onsubmit="handleSync(event)">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</label>
                <select name="year" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    
                    {% for year in range(current_year - 1, current_year + 3) %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>
                            ‡∏û.‡∏®. {{ year + 543 }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="flex justify-end space-x-4">
                <button type="button" onclick="closeSyncModal()" 
                        class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button type="submit"
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Holiday Modal -->
<div id="holidayModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
        <h2 id="modalTitle" class="text-2xl font-bold text-gray-900 mb-6">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</h2>
        
        <form id="holidayForm" onsubmit="handleSaveHoliday(event)">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" id="holidayId" name="id">
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà *</label>
                    <input type="date" name="date" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î *</label>
                    <input type="text" name="name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                           placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                    <textarea name="description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                              placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4 mt-6">
                <button type="button" onclick="closeHolidayModal()" 
                        class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button type="submit"
                        class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    /**
     * ‡∏î‡∏∂‡∏á Subdomain ‡∏à‡∏≤‡∏Å URL ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
     * ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á hostname (‡πÄ‡∏ä‡πà‡∏ô humnoi.localhost)
     * ‡πÅ‡∏•‡∏∞ query parameter (‡πÄ‡∏ä‡πà‡∏ô localhost?subdomain=humnoi)
     * @returns {string|null} - ‡∏ä‡∏∑‡πà‡∏≠ subdomain ‡∏´‡∏£‡∏∑‡∏≠ null ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö
     */
    function getSubdomain() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('subdomain')) {
            return urlParams.get('subdomain');
        }

        const hostname = window.location.hostname;
        const parts = hostname.split('.');
        // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏™‡πà‡∏ß‡∏ô ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏£‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 'www' ‡∏´‡∏£‡∏∑‡∏≠ 'localhost'
        if (parts.length > 1 && !['www', 'localhost', '127'].includes(parts[0])) {
            return parts[0];
        }
        return null;
    }

    /**
     * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ URL ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ä‡πâ subdomain ‡πÉ‡∏ô hostname ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
     * @returns {boolean} - true ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ (‡πÄ‡∏ä‡πà‡∏ô humnoi.localhost)
     */
    function isSubdomainInHost() {
        const hostname = window.location.hostname;
        const parts = hostname.split('.');
        return parts.length > 1 && !['www', 'localhost', '127'].includes(parts[0]);
    }

    /**
     * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
     * @param {string} basePath - URL ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Flask
     * @param {Object} [params={}] - ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
     * @returns {string} - URL ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
     */
    function buildUrl(basePath, params = {}) {
        const url = new URL(basePath, window.location.origin);
        const subdomain = getSubdomain();

        // ‡∏ñ‡πâ‡∏≤ subdomain ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô host (‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô localhost) ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô query param
        if (subdomain && !isSubdomainInHost()) {
            url.searchParams.set('subdomain', subdomain);
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ
        for (const key in params) {
            url.searchParams.set(key, params[key]);
        }
        
        return url.pathname + url.search;
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° UI ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ (‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ buildUrl ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà) ---

    function changeYear() {
        const year = document.getElementById('yearSelect').value;
        window.location.href = buildUrl('{{ url("holidays.holiday_settings") }}', { year: year });
    }

    function showSyncModal() {
        document.getElementById('syncModal').classList.remove('hidden');
    }
    function closeSyncModal() {
        document.getElementById('syncModal').classList.add('hidden');
    }

    function showAddModal() {
        document.getElementById('modalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î';
        const form = document.getElementById('holidayForm');
        form.action = buildUrl('{{ url("holidays.add_custom_holiday") }}');
        form.reset();
        document.getElementById('holidayId').value = '';
        document.getElementById('holidayModal').classList.remove('hidden');
    }
    function closeHolidayModal() {
        document.getElementById('holidayModal').classList.add('hidden');
    }

    async function handleSync(event) {
        event.preventDefault();
        const form = document.getElementById('syncForm');
        const formData = new FormData(form);
        const actionUrl = buildUrl(form.getAttribute('action') || '{{ url("holidays.sync_holidays") }}');

        try {
            const response = await fetch(actionUrl, { method: 'POST', body: formData });
            if (response.ok && response.redirected) {
                window.location.href = response.url; 
            } else if(response.ok) {
                 window.location.reload();
            }
            else {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
        } catch (error) {
            console.error('Sync error:', error);
            alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
        }
    }

    async function handleSaveHoliday(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        
        try {
            const response = await fetch(form.action, { method: 'POST', body: formData });
            if (response.ok && response.redirected) {
                window.location.href = response.url;
            } else if (response.ok) {
                window.location.reload();
            } else {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
            }
        } catch (error) {
            console.error('Save error:', error);
            alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
        }
    }

    async function toggleHoliday(checkbox) {
        const url = checkbox.dataset.toggleUrl;
        const isActive = checkbox.checked;
        
        const formData = new FormData();
        formData.append('csrf_token', '{{ csrf_token() }}');
        formData.append('is_active', isActive);
        
        try {
            const response = await fetch(buildUrl(url), { method: 'POST', body: formData });
            if (!response.ok) {
                checkbox.checked = !isActive;
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞');
            }
        } catch (error) {
            checkbox.checked = !isActive;
            console.error('Toggle error:', error);
        }
    }

    async function deleteHoliday(button) {
        const url = button.dataset.deleteUrl;
        if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏µ‡πâ?')) return;
        
        const formData = new FormData();
        formData.append('csrf_token', '{{ csrf_token() }}');
        
        try {
            const response = await fetch(buildUrl(url), { method: 'POST', body: formData });
            if (response.ok && response.redirected) {
                window.location.href = response.url;
            } else if (response.ok) {
                window.location.reload();
            } else {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
            }
        } catch (error) {
            console.error('Delete error:', error);
            alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
        }
    }
</script>
{% endblock %}