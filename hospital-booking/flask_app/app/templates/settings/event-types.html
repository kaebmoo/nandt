<!-- templates/settings/event-types.html -->
{% extends "base.html" %}

{% block title %}ประเภทการนัดหมาย - NudDee{% endblock %}

{% block extra_css %}
<style>
    body { font-family: 'Sarabun', sans-serif; }
    .event-type-card {
        transition: all 0.2s ease;
    }
    .event-type-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    
    <!-- Header -->
    <div class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">ประเภทการนัดหมาย</h1>
                <p class="mt-2 text-gray-600">จัดการประเภทการนัดหมายสำหรับระบบจองออนไลน์</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="addEventType()" 
                        class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                    <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    เพิ่มประเภทใหม่
                </button>
            </div>
        </div>
    </div>

    <!-- Event Types List -->
    <div id="eventTypesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Event types will be loaded here via JavaScript -->
    </div>

    <!-- Empty State (จะถูกแสดงโดย JavaScript) -->
    <div id="emptyState" class="hidden">
        <div class="bg-white rounded-xl shadow-sm border p-12 text-center">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">ยังไม่มีประเภทการนัดหมาย</h3>
            <p class="text-sm text-gray-500 mb-4">เริ่มต้นสร้างประเภทการนัดหมายแรกของคุณ</p>
            <button onclick="addEventType()" 
                    class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                เพิ่มประเภทใหม่
            </button>
        </div>
    </div>
</div>

<!-- Add/Edit Event Type Modal -->
<div id="eventTypeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 id="modalTitle" class="text-2xl font-bold text-gray-900">เพิ่มประเภทการนัดหมายใหม่</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form id="eventTypeForm" class="space-y-6">
            <input type="hidden" id="eventTypeId" name="id">
            
            <!-- Basic Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="eventName" class="block text-sm font-medium text-gray-700 mb-2">
                        ชื่อประเภทการนัดหมาย *
                    </label>
                    <input type="text" id="eventName" name="name" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                           placeholder="เช่น ตรวจสุขภาพทั่วไป">
                </div>
                
                <div>
                    <label for="eventDuration" class="block text-sm font-medium text-gray-700 mb-2">
                        ระยะเวลา (นาที) *
                    </label>
                    <select id="eventDuration" name="duration_minutes" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="15">15 นาที</option>
                        <option value="30" selected>30 นาที</option>
                        <option value="45">45 นาที</option>
                        <option value="60">1 ชั่วโมง</option>
                        <option value="90">1.5 ชั่วโมง</option>
                        <option value="120">2 ชั่วโมง</option>
                    </select>
                </div>
            </div>

            <div>
                <label for="eventDescription" class="block text-sm font-medium text-gray-700 mb-2">
                    คำอธิบาย
                </label>
                <textarea id="eventDescription" name="description" rows="3"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                          placeholder="อธิบายรายละเอียดของการนัดหมายประเภทนี้..."></textarea>
            </div>

            <!-- Availability Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">เลือกเวลาทำการ</label>
                <div id="availabilityOptions" class="space-y-2">
                    <!-- Availability options will be loaded here -->
                </div>
            </div>

            <!-- Settings -->
            <div class="space-y-4">
                <h3 class="text-lg font-medium text-gray-900">การตั้งค่าเพิ่มเติม</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="bufferTime" class="block text-sm font-medium text-gray-700 mb-2">
                            เวลาพักระหว่างนัด (นาที)
                        </label>
                        <select id="bufferTime" name="buffer_time_minutes"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="0">ไม่มี</option>
                            <option value="5">5 นาที</option>
                            <option value="10" selected>10 นาที</option>
                            <option value="15">15 นาที</option>
                            <option value="30">30 นาที</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="advanceBooking" class="block text-sm font-medium text-gray-700 mb-2">
                            จองล่วงหน้าได้ (วัน)
                        </label>
                        <select id="advanceBooking" name="advance_booking_days"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="7">7 วัน</option>
                            <option value="14">14 วัน</option>
                            <option value="30" selected>30 วัน</option>
                            <option value="60">60 วัน</option>
                            <option value="90">90 วัน</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="isActive" name="is_active" checked
                               class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                        <span class="text-sm text-gray-700">เปิดใช้งาน</span>
                    </label>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end space-x-4 pt-6 border-t">
                <button type="button" onclick="closeModal()" 
                        class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    ยกเลิก
                </button>
                <button type="submit"
                        class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    บันทึก
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // === Keep all existing JavaScript logic intact ===
    const API_BASE = 'http://localhost:8000/api/v1';
    
    function getSubdomain() {
        const hostname = window.location.hostname;
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('subdomain')) {
            return urlParams.get('subdomain');
        }
        if (hostname !== 'localhost' && hostname.includes('.')) {
            const parts = hostname.split('.');
            if (parts.length > 1 && (parts[1] === 'localhost' || parts.length > 2)) {
                return parts[0];
            }
        }
        return '{{ subdomain or "humnoi" }}'; // Use Flask variable if available
    }
    
    const SUBDOMAIN = getSubdomain();
    
    let eventTypes = [];
    let availabilities = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadEventTypes();
        loadAvailabilities();
    });

    async function loadEventTypes() {
        try {
            const response = await fetch(`${API_BASE}/tenants/${SUBDOMAIN}/event-types`);
            if (!response.ok) throw new Error('Failed to load event types');
            const data = await response.json();
            eventTypes = data.event_types || [];
            renderEventTypes();
        } catch (error) {
            console.error('Error loading event types:', error);
            renderEventTypes(); // Still render empty state
        }
    }

    async function loadAvailabilities() {
        try {
            const response = await fetch(`${API_BASE}/tenants/${SUBDOMAIN}/availability/templates`);
            if (!response.ok) throw new Error('Failed to load availability templates');
            const data = await response.json();
            availabilities = data.templates || [];
        } catch (error) {
            console.error('Error loading availability templates:', error);
        }
    }

    function renderEventTypes() {
        const container = document.getElementById('eventTypesList');
        const emptyState = document.getElementById('emptyState');
        
        if (eventTypes.length === 0) {
            container.style.display = 'none';
            emptyState.classList.remove('hidden');
            return;
        }
        
        container.style.display = 'grid';
        emptyState.classList.add('hidden');
        
        container.innerHTML = eventTypes.map(et => `
            <div class="event-type-card bg-white rounded-xl shadow-sm border p-6">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold text-gray-900">${et.name}</h3>
                        <p class="text-sm text-gray-600 mt-1">${et.description || ''}</p>
                        <div class="mt-4 space-y-2 text-sm">
                            <div class="flex items-center space-x-4">
                                <span class="text-gray-500">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    ${et.duration_minutes} นาที
                                </span>
                                <span class="text-gray-500">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    พัก ${et.buffer_before_minutes} นาที
                                </span>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="text-gray-500">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    ${et.availability_name || 'เวลาทำการเริ่มต้น'}
                                </span>
                            </div>
                            <div>
                                <span class="${et.is_active ? 'text-green-600' : 'text-gray-500'}">
                                    ${et.is_active ? '● เปิดใช้งาน' : '○ ปิดใช้งาน'}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-1 ml-3">
                        <button onclick="editEventType(${et.id})" 
                                class="p-1 text-gray-400 hover:text-blue-600 transition-colors"
                                title="แก้ไข">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button onclick="deleteEventType(${et.id})" 
                                class="p-1 text-gray-400 hover:text-red-600 transition-colors"
                                title="ลบ">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // === Keep all other functions exactly the same ===
    function addEventType() {
        document.getElementById('modalTitle').textContent = 'เพิ่มประเภทการนัดหมายใหม่';
        document.getElementById('eventTypeForm').reset();
        document.getElementById('eventTypeId').value = '';
        document.getElementById('isActive').checked = true;
        renderAvailabilityOptions();
        document.getElementById('eventTypeModal').classList.remove('hidden');
    }

    function editEventType(id) {
        const eventType = eventTypes.find(et => et.id === id);
        if (!eventType) return;
        document.getElementById('modalTitle').textContent = 'แก้ไขประเภทการนัดหมาย';
        document.getElementById('eventTypeId').value = eventType.id;
        document.getElementById('eventName').value = eventType.name;
        document.getElementById('eventDuration').value = eventType.duration_minutes;
        document.getElementById('eventDescription').value = eventType.description || '';
        document.getElementById('bufferTime').value = eventType.buffer_before_minutes || 0;
        document.getElementById('advanceBooking').value = eventType.max_advance_days || 30;
        document.getElementById('isActive').checked = eventType.is_active;
        renderAvailabilityOptions(eventType.template_id);
        document.getElementById('eventTypeModal').classList.remove('hidden');
    }

    function renderAvailabilityOptions(selectedId = null) {
        const container = document.getElementById('availabilityOptions');
        let optionsHTML = '<option value="">ใช้เวลาทำการเริ่มต้น</option>';
        availabilities.forEach(template => {
            const selected = selectedId === template.id ? 'selected' : '';
            optionsHTML += `<option value="${template.id}" ${selected}>${template.name}</option>`;
        });
        container.innerHTML = `
            <select id="availabilitySelect" name="template_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                ${optionsHTML}
            </select>
            <div class="mt-2">
                <a href="{{ nav_url('availability.availability_settings') }}" 
                   class="text-sm text-purple-600 hover:text-purple-700">
                    + จัดการรูปแบบเวลาทำการ
                </a>
            </div>`;
    }

    function closeModal() {
        document.getElementById('eventTypeModal').classList.add('hidden');
    }

    document.getElementById('eventTypeForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        const bufferTime = parseInt(formData.get('buffer_time_minutes'));
        const eventTypeData = {
            name: formData.get('name'),
            description: formData.get('description'),
            duration_minutes: parseInt(formData.get('duration_minutes')),
            buffer_before_minutes: bufferTime,
            buffer_after_minutes: bufferTime,
            max_advance_days: parseInt(formData.get('advance_booking_days')),
            is_active: formData.has('is_active'),
            template_id: formData.get('template_id') ? parseInt(formData.get('template_id')) : null
        };

        try {
            const eventTypeId = formData.get('id');
            const method = eventTypeId ? 'PUT' : 'POST';
            const url = eventTypeId 
                ? `${API_BASE}/tenants/${SUBDOMAIN}/event-types/${eventTypeId}`
                : `${API_BASE}/tenants/${SUBDOMAIN}/event-types`;

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(eventTypeData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to save event type');
            }

            closeModal();
            await loadEventTypes();
            
            // Use Flask's flash messages style notification
            window.utils.showNotification(
                eventTypeId ? 'แก้ไขเรียบร้อยแล้ว!' : 'เพิ่มประเภทการนัดหมายเรียบร้อยแล้ว!',
                'success'
            );
        } catch (error) {
            console.error('Error saving event type:', error);
            window.utils.showNotification('เกิดข้อผิดพลาด: ' + error.message, 'error');
        }
    });

    async function deleteEventType(id) {
        if (!confirm('คุณแน่ใจหรือไม่ว่าต้องการลบประเภทการนัดหมายนี้?')) return;
        try {
            const response = await fetch(`${API_BASE}/tenants/${SUBDOMAIN}/event-types/${id}`, { 
                method: 'DELETE' 
            });
            if (!response.ok) throw new Error('Failed to delete event type');
            await loadEventTypes();
            window.utils.showNotification('ลบเรียบร้อยแล้ว!', 'success');
        } catch (error) {
            console.error('Error deleting event type:', error);
            window.utils.showNotification('เกิดข้อผิดพลาด: ' + error.message, 'error');
        }
    }
</script>
{% endblock %}