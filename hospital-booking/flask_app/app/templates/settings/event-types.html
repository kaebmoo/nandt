<!-- hospital-booking/flask_app/settings/event-types.html -->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประเภทการนัดหมาย - MedBooking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <button onclick="history.back()" class="text-gray-600 hover:text-gray-900">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h1 class="text-xl font-semibold text-gray-900">ประเภทการนัดหมาย</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="addEventType()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                        เพิ่มประเภทใหม่
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- Event Types List -->
        <div id="eventTypesList" class="space-y-6">
            <!-- Event types will be loaded here -->
        </div>
    </div>

    <!-- Add/Edit Event Type Modal -->
    <div id="eventTypeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-2xl font-bold">เพิ่มประเภทการนัดหมายใหม่</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <form id="eventTypeForm" class="space-y-6">
                <input type="hidden" id="eventTypeId" name="id">
                
                <!-- Basic Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="eventName" class="block text-sm font-medium text-gray-700 mb-2">ชื่อประเภทการนัดหมาย *</label>
                        <input type="text" id="eventName" name="name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                               placeholder="เช่น ตรวจสุขภาพทั่วไป">
                    </div>
                    
                    <div>
                        <label for="eventDuration" class="block text-sm font-medium text-gray-700 mb-2">ระยะเวลา (นาที) *</label>
                        <select id="eventDuration" name="duration_minutes" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="15">15 นาที</option>
                            <option value="30" selected>30 นาที</option>
                            <option value="45">45 นาที</option>
                            <option value="60">1 ชั่วโมง</option>
                            <option value="90">1.5 ชั่วโมง</option>
                            <option value="120">2 ชั่วโมง</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="eventDescription" class="block text-sm font-medium text-gray-700 mb-2">คำอธิบาย</label>
                    <textarea id="eventDescription" name="description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                              placeholder="อธิบายรายละเอียดของการนัดหมายประเภทนี้..."></textarea>
                </div>

                <!-- Pricing -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="eventPrice" class="block text-sm font-medium text-gray-700 mb-2">ค่าบริการ (บาท)</label>
                        <input type="number" id="eventPrice" name="price" min="0" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                               placeholder="0">
                    </div>
                    
                    <div>
                        <label for="eventCurrency" class="block text-sm font-medium text-gray-700 mb-2">สกุลเงิน</label>
                        <select id="eventCurrency" name="currency"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="THB" selected>บาท (THB)</option>
                            <option value="USD">ดอลลาร์ (USD)</option>
                        </select>
                    </div>
                </div>

                <!-- Availability Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">เลือกเวลาทำการ</label>
                    <div id="availabilityOptions" class="space-y-2">
                        <!-- Availability options will be loaded here -->
                    </div>
                </div>

                <!-- Settings -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-900">การตั้งค่าเพิ่มเติม</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="bufferTime" class="block text-sm font-medium text-gray-700 mb-2">เวลาพักระหว่างนัด (นาที)</label>
                            <select id="bufferTime" name="buffer_time_minutes"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="0">ไม่มี</option>
                                <option value="5">5 นาที</option>
                                <option value="10" selected>10 นาที</option>
                                <option value="15">15 นาที</option>
                                <option value="30">30 นาที</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="advanceBooking" class="block text-sm font-medium text-gray-700 mb-2">จองล่วงหน้าได้ (วัน)</label>
                            <select id="advanceBooking" name="advance_booking_days"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="7">7 วัน</option>
                                <option value="14">14 วัน</option>
                                <option value="30" selected>30 วัน</option>
                                <option value="60">60 วัน</option>
                                <option value="90">90 วัน</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex items-center space-x-4">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="requiresConfirmation" name="requires_confirmation"
                                   class="h-4 w-4 text-purple-600 border-gray-300 rounded">
                            <span class="text-sm text-gray-700">ต้องการการยืนยันจากเจ้าหน้าที่</span>
                        </label>
                        
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="isActive" name="is_active" checked
                                   class="h-4 w-4 text-purple-600 border-gray-300 rounded">
                            <span class="text-sm text-gray-700">เปิดใช้งาน</span>
                        </label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-4 pt-6 border-t">
                    <button type="button" onclick="closeModal()" 
                            class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        ยกเลิก
                    </button>
                    <button type="submit"
                            class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        บันทึก
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        
        // Auto-detect subdomain from current URL
        function getSubdomain() {
            const hostname = window.location.hostname;
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check if subdomain is in URL parameter first
            if (urlParams.has('subdomain')) {
                return urlParams.get('subdomain');
            }
            
            // Check if we're on a subdomain like humnoi.localhost
            if (hostname !== 'localhost' && hostname.includes('.')) {
                const parts = hostname.split('.');
                if (parts.length > 1 && parts[1] === 'localhost') {
                    return parts[0]; // Return subdomain part
                }
            }
            
            // Default fallback
            return 'humnoi';
        }
        
        const SUBDOMAIN = getSubdomain();
        console.log('Using subdomain:', SUBDOMAIN);
        
        let eventTypes = [];
        let availabilities = [];

        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadEventTypes();
            loadAvailabilities();
        });

        async function loadEventTypes() {
            try {
                const response = await fetch(`${API_BASE}/tenants/${SUBDOMAIN}/event-types`);
                const data = await response.json();
                eventTypes = data.event_types;
                renderEventTypes();
            } catch (error) {
                console.error('Error loading event types:', error);
            }
        }

        async function loadAvailabilities() {
            try {
                const response = await fetch(`${API_BASE}/tenants/${SUBDOMAIN}/availability/templates`);
                const data = await response.json();
                availabilities = data.templates || [];
            } catch (error) {
                console.error('Error loading availability templates:', error);
            }
        }

        function renderEventTypes() {
            const container = document.getElementById('eventTypesList');
            
            if (eventTypes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">ยังไม่มีประเภทการนัดหมาย</h3>
                        <p class="text-gray-500 mb-4">เริ่มต้นสร้างประเภทการนัดหมายแรกของคุณ</p>
                        <button onclick="addEventType()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                            เพิ่มประเภทใหม่
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = eventTypes.map(eventType => `
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <h3 class="text-xl font-semibold text-gray-900">${eventType.name}</h3>
                                <span class="px-2 py-1 text-sm rounded-full ${eventType.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                    ${eventType.is_active ? 'เปิดใช้งาน' : 'ปิดใช้งาน'}
                                </span>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                                <div>
                                    <span class="text-sm text-gray-500">ระยะเวลา</span>
                                    <p class="font-medium">${eventType.duration_minutes} นาที</p>
                                </div>
                                <div>
                                    <span class="text-sm text-gray-500">ค่าบริการ</span>
                                    <p class="font-medium">${eventType.price || 0} ${eventType.currency || 'THB'}</p>
                                </div>
                                <div>
                                    <span class="text-sm text-gray-500">เวลาพักระหว่างนัด</span>
                                    <p class="font-medium">${eventType.buffer_time_minutes || 0} นาที</p>
                                </div>
                                <div>
                                    <span class="text-sm text-gray-500">จองล่วงหน้า</span>
                                    <p class="font-medium">${eventType.advance_booking_days || 30} วัน</p>
                                </div>
                            </div>
                            
                            ${eventType.description ? `
                                <div class="mt-4">
                                    <span class="text-sm text-gray-500">คำอธิบาย</span>
                                    <p class="text-gray-700">${eventType.description}</p>
                                </div>
                            ` : ''}
                            
                            <div class="mt-4">
                                <span class="text-sm text-gray-500">การยืนยัน</span>
                                <p class="text-sm ${eventType.requires_confirmation ? 'text-orange-600' : 'text-green-600'}">
                                    ${eventType.requires_confirmation ? 'ต้องการการยืนยัน' : 'ยืนยันอัตโนมัติ'}
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-2 ml-4">
                            <button onclick="editEventType(${eventType.id})" 
                                    class="p-2 text-gray-400 hover:text-gray-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="deleteEventType(${eventType.id})" 
                                    class="p-2 text-gray-400 hover:text-red-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addEventType() {
            document.getElementById('modalTitle').textContent = 'เพิ่มประเภทการนัดหมายใหม่';
            document.getElementById('eventTypeForm').reset();
            document.getElementById('eventTypeId').value = '';
            document.getElementById('isActive').checked = true;
            renderAvailabilityOptions();
            document.getElementById('eventTypeModal').classList.remove('hidden');
        }

        function editEventType(id) {
            const eventType = eventTypes.find(et => et.id === id);
            if (!eventType) return;

            document.getElementById('modalTitle').textContent = 'แก้ไขประเภทการนัดหมาย';
            
            // Fill form with existing data
            document.getElementById('eventTypeId').value = eventType.id;
            document.getElementById('eventName').value = eventType.name;
            document.getElementById('eventDuration').value = eventType.duration_minutes;
            document.getElementById('eventDescription').value = eventType.description || '';
            document.getElementById('eventPrice').value = eventType.price || '';
            document.getElementById('eventCurrency').value = eventType.currency || 'THB';
            document.getElementById('bufferTime').value = eventType.buffer_time_minutes || 0;
            document.getElementById('advanceBooking').value = eventType.advance_booking_days || 30;
            document.getElementById('requiresConfirmation').checked = eventType.requires_confirmation || false;
            document.getElementById('isActive').checked = eventType.is_active !== false;

            renderAvailabilityOptions(eventType.availability_id);
            document.getElementById('eventTypeModal').classList.remove('hidden');
        }

        function renderAvailabilityOptions(selectedId = null) {
            const container = document.getElementById('availabilityOptions');
            
            let optionsHTML = '<option value="">เลือกรูปแบบเวลาทำการ...</option>';
            
            // Use templates directly (already grouped by backend)
            availabilities.forEach(template => {
                const selected = selectedId === template.id ? 'selected' : '';
                
                // Convert day numbers to Thai day names
                const dayNames = {
                    0: 'อา', 1: 'จ', 2: 'อ', 3: 'พ', 4: 'พฤ', 5: 'ศ', 6: 'ส'
                };
                const days = template.days.map(dayNum => dayNames[dayNum]).join(', ');
                
                optionsHTML += `<option value="${template.id}" ${selected}>
                    ${template.name} (${days})
                </option>`;
            });
            
            container.innerHTML = `
                <select id="availabilitySelect" name="availability_id" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    ${optionsHTML}
                </select>
                <p class="text-sm text-gray-500 mt-1">
                    เลือกรูปแบบเวลาทำการที่จะใช้กับประเภทการนัดหมายนี้ หากไม่เลือกจะใช้เวลาทำการแรกที่มี
                </p>
                <div class="mt-2">
                    <button type="button" onclick="window.location.href='/settings/availability'" 
                            class="text-sm text-purple-600 hover:text-purple-700">
                        + จัดการรูปแบบเวลาทำการ
                    </button>
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('eventTypeModal').classList.add('hidden');
        }

        document.getElementById('eventTypeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const eventTypeData = {
                name: formData.get('name'),
                description: formData.get('description'),
                duration_minutes: parseInt(formData.get('duration_minutes')),
                price: formData.get('price') ? parseFloat(formData.get('price')) : null,
                currency: formData.get('currency'),
                buffer_time_minutes: parseInt(formData.get('buffer_time_minutes')),
                advance_booking_days: parseInt(formData.get('advance_booking_days')),
                requires_confirmation: formData.has('requires_confirmation'),
                is_active: formData.has('is_active'),
                availability_id: formData.get('availability_id') || null
            };

            try {
                const eventTypeId = formData.get('id');
                const method = eventTypeId ? 'PUT' : 'POST';
                const url = eventTypeId 
                    ? `${API_BASE}/tenants/${SUBDOMAIN}/event-types/${eventTypeId}`
                    : `${API_BASE}/tenants/${SUBDOMAIN}/event-types`;

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(eventTypeData)
                });

                if (!response.ok) {
                    throw new Error('Failed to save event type');
                }

                closeModal();
                await loadEventTypes();
                alert(eventTypeId ? 'แก้ไขเรียบร้อยแล้ว!' : 'เพิ่มประเภทการนัดหมายเรียบร้อยแล้ว!');

            } catch (error) {
                console.error('Error saving event type:', error);
                alert('เกิดข้อผิดพลาด: ' + error.message);
            }
        });

        async function deleteEventType(id) {
            if (!confirm('คุณแน่ใจหรือไม่ว่าต้องการลบประเภทการนัดหมายนี้?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tenants/${SUBDOMAIN}/event-types/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete event type');
                }

                await loadEventTypes();
                alert('ลบเรียบร้อยแล้ว!');

            } catch (error) {
                console.error('Error deleting event type:', error);
                alert('เกิดข้อผิดพลาด: ' + error.message);
            }
        }
    </script>
</body>
</html>