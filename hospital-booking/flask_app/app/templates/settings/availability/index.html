<!-- templates/settings/availability/index.html -->
{% extends "base.html" %}
{% from 'macros/forms.html' import render_field, render_field_errors %}

{% block title %}‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ - NudDee{% endblock %}

{% block extra_css %}
<style>
    .template-item {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .template-item:hover {
        background-color: #f3f4f6;
    }
    .template-item.active {
        background-color: #e0e7ff;
        border-color: #6366f1;
        box-shadow: 0 0 0 2px #6366f1;
    }
    .override-item {
        transition: all 0.2s ease;
    }
    .day-schedule {
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    
    <!-- Header -->
    <div class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</h1>
                <p class="mt-2 text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</p>
            </div>
            <div class="flex space-x-3">
                <a href="{{ url('availability.create_template') }}" 
                   class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                    <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÉ‡∏´‡∏°‡πà
                </a>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Templates List -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-6">‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</h2>
                
                {% if templates %}
                    <div class="space-y-3" id="templates-list">
                        {% for template in templates %}
                            <div class="template-item border rounded-lg p-4 hover:bg-gray-100 {% if selected_template and selected_template.id == template.id %}active bg-blue-50 border-blue-500{% else %}bg-gray-50{% endif %}" 
                                 data-template-id="{{ template.id }}"
                                 onclick="selectTemplate({{ template.id }})">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <h3 class="font-medium text-gray-900 mb-1">{{ template.name }}</h3>
                                        {% if template.description %}
                                            <p class="text-sm text-gray-600 mb-2">{{ template.description }}</p>
                                        {% endif %}
                                        <div class="text-xs text-gray-500">
                                            <span>‡∏ß‡∏±‡∏ô: </span>
                                            {% for day_num in template.days %}
                                                <span class="inline-block bg-gray-200 text-gray-700 px-2 py-0.5 rounded mr-1">
                                                    {{ day_num | day_name_th_short }}
                                                </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-1 ml-3">
                                        <a href="{{ url('availability.edit_template', template_id=template.id) }}" 
                                           class="p-1 text-gray-400 hover:text-blue-600 transition-colors"
                                           title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"
                                           onclick="event.stopPropagation()">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </a>
                                        <!-- 
                                        <form method="POST" action="{{ url('availability.delete_template', template_id=template.id) }}" 
                                              style="display: inline;" 
                                              onsubmit="event.stopPropagation(); return confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏ô‡∏µ‡πâ?\n\n‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏´‡∏≤‡∏Å Event Type ‡πÉ‡∏î‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥')">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <button type="submit" 
                                                    class="p-1 text-gray-400 hover:text-red-600 transition-colors"
                                                    title="‡∏•‡∏ö">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                </svg>
                                            </button>
                                        </form>
                                        -->
                                        <!-- ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å form ‡πÄ‡∏õ‡πá‡∏ô button ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ -->
                                        <button type="button" 
                                                class="p-1 text-gray-400 hover:text-red-600 transition-colors"
                                                title="‡∏•‡∏ö"
                                                data-template-name="{{ template.name|e }}"
                                                onclick="deleteTemplate(event, {{ template.id }})">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-12 text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï</h3>
                        <p class="text-sm mb-4">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                        <a href="{{ url('availability.create_template') }}" 
                           class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÉ‡∏´‡∏°‡πà
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Template Details & Management Sections -->
        <div class="lg:col-span-2 space-y-8">
            {% set template_type_labels = {
                'dedicated': '‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Dedicated)',
                'shared': '‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Shared)',
                'pool': '‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ß‡∏°/‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Provider Pool)'
            } %}
            {% set schedule_map = {} %}
            {% set provider_assignments = [] %}
            {% set provider_schedules = [] %}
            {% set resource_capacities = [] %}
            {% set assigned_ids = [] %}
            {% set scheduled_provider_ids = [] %}
            {% set provider_count = 0 %}
            {% if selected_template %}
                {% set schedule_map = selected_template.schedule or {} %}
                {% set provider_assignments = selected_template.providers_detail or [] %}
                {% set provider_schedules = selected_template.provider_schedules_detail or [] %}
                {% set resource_capacities = selected_template.resource_capacities_detail or [] %}
                {% set assigned_ids = provider_assignments | map(attribute='provider_id') | list %}
                {% set scheduled_provider_ids = provider_schedules | selectattr('provider_id') | map(attribute='provider_id') | list %}
                {% set provider_count = selected_template.provider_count if selected_template.provider_count is not none else provider_assignments|length %}
            {% endif %}

            <div id="template-details" class="bg-white rounded-xl shadow-sm border p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï</h3>
                    {% if selected_template %}
                        <a href="{{ url('availability.edit_template', template_id=selected_template.id) }}"
                           class="text-sm text-purple-600 hover:text-purple-800 transition-colors">
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï
                        </a>
                    {% endif %}
                </div>
                <div id="template-details-content">
                    {% if selected_template %}
                        <div class="mb-4">
                            <h4 class="font-medium text-gray-900 mb-2">{{ selected_template.name }}</h4>
                            {% if selected_template.description %}
                                <p class="text-sm text-gray-600 mb-3">{{ selected_template.description }}</p>
                            {% endif %}
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="border rounded-lg p-4 bg-indigo-50 border-indigo-200">
                                <p class="text-xs font-semibold text-indigo-700 uppercase tracking-wide">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï</p>
                                <p class="text-lg font-semibold text-indigo-900 mt-1">
                                    {{ template_type_labels.get(selected_template.template_type, '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') }}
                                </p>
                            </div>
                            <div class="border rounded-lg p-4 bg-sky-50 border-sky-200">
                                <p class="text-xs font-semibold text-sky-700 uppercase tracking-wide">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏ï‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</p>
                                <p class="text-lg font-semibold text-sky-900 mt-1">
                                    {{ selected_template.max_concurrent_slots or 1 }} ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                                </p>
                            </div>
                            <div class="border rounded-lg p-4 bg-emerald-50 border-emerald-200">
                                <p class="text-xs font-semibold text-emerald-700 uppercase tracking-wide">‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
                                <p class="text-lg font-semibold text-emerald-900 mt-1">
                                    {% if selected_template.requires_provider_assignment %}
                                        ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î / ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
                                    {% else %}
                                        ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
                                    {% endif %}
                                </p>
                            </div>
                            <div class="border rounded-lg p-4 bg-amber-50 border-amber-200">
                                <p class="text-xs font-semibold text-amber-700 uppercase tracking-wide">‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï</p>
                                <p class="text-lg font-semibold text-amber-900 mt-1">
                                    {{ provider_count }} ‡∏Ñ‡∏ô
                                </p>
                            </div>
                        </div>

                        <div class="mb-6">
                            <p class="text-xs uppercase text-gray-500 tracking-wide mb-2">‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ß‡∏•‡∏≤</p>
                            <div class="inline-flex items-center space-x-2 bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm">
                                <span>üïí</span>
                                <span>{{ selected_template.timezone or 'Asia/Bangkok' }}</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {% set day_names = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'] %}
                            {% for day_num in range(7) %}
                                {% set day_key = day_num|string %}
                                {% set day_slots = schedule_map.get(day_key) %}
                                {% set is_active = day_slots and day_slots|length > 0 %}
                                <div class="border rounded-lg p-3 {% if is_active %}bg-green-50 border-green-200{% else %}bg-gray-50 border-gray-200{% endif %}">
                                    <h5 class="font-medium text-gray-900 mb-1">{{ day_names[day_num] }}</h5>
                                    {% if is_active %}
                                        <div class="space-y-1">
                                            {% for slot in day_slots %}
                                                <div class="text-sm text-green-700 font-mono">{{ slot.start }} - {{ slot.end }}</div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="text-sm text-gray-500">‡∏õ‡∏¥‡∏î</div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8 text-gray-500">
                            <p class="text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border p-6" id="template-providers-card">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900">‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï</h2>
                        <p class="text-sm text-gray-600">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏à‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏ô‡∏µ‡πâ</p>
                    </div>
                    {% if selected_template %}
                        <button type="button"
                                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm"
                                onclick="openModal('provider-modal')">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
                        </button>
                    {% endif %}
                </div>
                {% if selected_template %}
                    {% if provider_assignments %}
                        <div class="space-y-4">
                            {% for assignment in provider_assignments %}
                                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                                    <div>
                                        <h3 class="text-sm font-semibold text-gray-900">
                                            {{ assignment.provider_name or '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£' }}
                                        </h3>
                                        <div class="text-sm text-gray-600">
                                            {% if assignment.title %}{{ assignment.title }}{% endif %}
                                            {% if assignment.department %} ‚Ä¢ {{ assignment.department }}{% endif %}
                                        </div>
                                        <div class="mt-2 space-x-2">
                                            {% if assignment.is_primary %}
                                                <span class="px-2 py-0.5 text-xs rounded-full bg-indigo-100 text-indigo-700">Primary</span>
                                            {% endif %}
                                            {% if assignment.can_auto_assign %}
                                                <span class="px-2 py-0.5 text-xs rounded-full bg-emerald-100 text-emerald-700">Auto Assign</span>
                                            {% else %}
                                                <span class="px-2 py-0.5 text-xs rounded-full bg-yellow-100 text-yellow-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="mt-4 md:mt-0 flex flex-col space-y-3 md:space-y-0 md:flex-row md:items-center md:space-x-4">
                                        {% if assignment.provider_id %}
                                            <form method="POST"
                                                  action="{{ url('availability.update_template_provider', template_id=selected_template.id, provider_id=assignment.provider_id) }}"
                                                  class="bg-white border border-gray-200 rounded-lg px-4 py-3 space-y-2">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <input type="hidden" name="assignment_id" value="{{ assignment.assignment_id }}">
                                                <div class="flex items-center space-x-2">
                                                    <input type="hidden" name="is_primary" value="off">
                                                    <input type="checkbox" name="is_primary" value="on"
                                                           {% if assignment.is_primary %}checked{% endif %}
                                                           class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                                    <span class="text-sm text-gray-700">Primary</span>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <input type="hidden" name="can_auto_assign" value="off">
                                                    <input type="checkbox" name="can_auto_assign" value="on"
                                                           {% if assignment.can_auto_assign %}checked{% endif %}
                                                           class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                                    <span class="text-sm text-gray-700">Auto Assign</span>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <label class="text-sm text-gray-700">Priority</label>
                                                    <input type="number" name="priority" value="{{ assignment.priority or 0 }}"
                                                           class="w-16 px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500">
                                                </div>
                                                <div class="flex justify-end">
                                                    <button type="submit"
                                                            class="text-sm px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors">
                                                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                                    </button>
                                                </div>
                                            </form>
                                            <form method="POST"
                                                  action="{{ url('availability.delete_template_provider', template_id=selected_template.id, provider_id=assignment.provider_id) }}"
                                                  onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <button type="submit"
                                                        class="px-4 py-2 border border-red-200 text-red-600 rounded-lg hover:bg-red-50 transition-colors">
                                                    ‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å
                                                </button>
                                            </form>
                                        {% else %}
                                            <div class="text-sm text-red-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á</div>
                                        {% endif %}
                                    </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8 text-gray-500 bg-gray-50 border border-dashed border-gray-300 rounded-lg">
                            <p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
                            <p class="text-xs mt-1 text-gray-400">‡∏Å‡∏î ‚Äú‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏ô‡∏µ‡πâ</p>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-8 text-gray-500">
                        <p class="text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
                    </div>
                {% endif %}
            </div>

            <div class="bg-white rounded-xl shadow-sm border p-6" id="provider-schedules-card">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h2>
                        <p class="text-sm text-gray-600">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏à‡∏≠‡∏á</p>
                    </div>
                    {% if selected_template %}
                        <button type="button"
                                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm"
                                onclick="openScheduleModalForCreate()">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                        </button>
                    {% endif %}
                </div>
                {% if selected_template %}
                    {% if provider_schedules %}
                        <div class="space-y-4">
                            {% for schedule in provider_schedules %}
                                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                                        <div>
                                            <h3 class="text-sm font-semibold text-gray-900">{{ schedule.provider_name or '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£' }}</h3>
                                            <div class="mt-1 text-sm text-gray-600 flex flex-wrap items-center gap-2">
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 text-xs">
                                                    {{ schedule.schedule_type|default('regular')|capitalize }}
                                                </span>
                                                <span class="text-xs text-gray-500">
                                                    ‡πÄ‡∏£‡∏¥‡πà‡∏° {{ schedule.effective_date }}
                                                    {% if schedule.end_date %}
                                                        ‚Ä¢ ‡∏ñ‡∏∂‡∏á {{ schedule.end_date }}
                                                    {% else %}
                                                        ‚Ä¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="mt-2 text-sm text-gray-700 flex flex-wrap gap-2">
                                                {% for day in schedule.days_of_week %}
                                                    <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs">
                                                        {{ day|day_name_th_short }}
                                                    </span>
                                                {% endfor %}
                                            </div>
                                            <div class="mt-2 text-sm text-gray-600">
                                                {% if schedule.custom_start_time and schedule.custom_end_time %}
                                                    ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£: {{ schedule.custom_start_time }} - {{ schedule.custom_end_time }}
                                                {% else %}
                                                    ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï
                                                {% endif %}
                                                {% if schedule.notes %}
                                                    <div class="text-xs text-gray-500 mt-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: {{ schedule.notes }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="mt-4 lg:mt-0 flex items-center space-x-3">
                                            <button type="button"
                                                    class="px-4 py-2 border border-purple-200 text-purple-700 rounded-lg hover:bg-purple-50 transition-colors text-sm"
                                                    onclick="openScheduleModalForEdit(this)"
                                                    data-schedule-id="{{ schedule.schedule_id }}"
                                                    data-provider-id="{{ schedule.provider_id }}"
                                                    data-effective-date="{{ schedule.effective_date }}"
                                                    data-end-date="{{ schedule.end_date or '' }}"
                                                    data-days="{{ schedule.days_of_week | default([], true) | join(',') }}"
                                                    data-schedule-type="{{ schedule.schedule_type or 'regular' }}"
                                                    data-start-time="{{ schedule.custom_start_time or '' }}"
                                                    data-end-time="{{ schedule.custom_end_time or '' }}"
                                                    data-notes="{{ schedule.notes or '' }}"
                                                    data-is-active="{{ 'true' if schedule.is_active else 'false' }}">
                                                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                            </button>

                                            <form method="POST"
                                                  action="{{ url('availability.toggle_provider_schedule', template_id=selected_template.id, schedule_id=schedule.schedule_id) }}">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <input type="hidden" name="is_active" value="{{ 'on' if not schedule.is_active else 'off' }}">
                                                <button type="submit"
                                                        class="px-4 py-2 text-sm rounded-lg border transition-colors {% if schedule.is_active %}border-emerald-200 text-emerald-700 hover:bg-emerald-50{% else %}border-gray-200 text-gray-600 hover:bg-gray-100{% endif %}">
                                                    {% if schedule.is_active %}‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô{% else %}‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô{% endif %}
                                                </button>
                                            </form>
                                            <form method="POST"
                                                  action="{{ url('availability.delete_provider_schedule', template_id=selected_template.id, schedule_id=schedule.schedule_id) }}"
                                                  onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <button type="submit"
                                                        class="px-4 py-2 border border-red-200 text-red-600 rounded-lg hover:bg-red-50 transition-colors text-sm">
                                                    ‡∏•‡∏ö
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8 text-gray-500 bg-gray-50 border border-dashed border-gray-300 rounded-lg">
                            <p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
                            <p class="text-xs mt-1 text-gray-400">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-8 text-gray-500">
                        <p class="text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
                    </div>
                {% endif %}
            </div>

            <div class="bg-white rounded-xl shadow-sm border p-6" id="resource-capacity-card">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900">‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ (Resource Capacity)</h2>
                        <p class="text-sm text-gray-600">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏¥‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÜ</p>
                    </div>
                    {% if selected_template %}
                        <button type="button"
                                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm"
                                onclick="openModal('capacity-modal')">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î
                        </button>
                    {% endif %}
                </div>
                {% if selected_template %}
                    {% if resource_capacities %}
                        <div class="space-y-4">
                            {% for capacity in resource_capacities %}
                                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                                        <div>
                                            <div class="flex items-center space-x-2">
                                                <h3 class="text-sm font-semibold text-gray-900">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
                                                {% if capacity.is_active %}
                                                    <span class="px-2 py-0.5 text-xs rounded-full bg-emerald-100 text-emerald-700">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</span>
                                                {% else %}
                                                    <span class="px-2 py-0.5 text-xs rounded-full bg-gray-200 text-gray-600">‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                                                {% endif %}
                                            </div>
                                            <div class="mt-2 text-sm text-gray-700 space-y-1">
                                                <div>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ {{ capacity.available_rooms }} ‡∏´‡πâ‡∏≠‡∏á/‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</div>
                                                {% if capacity.max_concurrent_appointments %}
                                                    <div>‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î {{ capacity.max_concurrent_appointments }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                                                {% endif %}
                                                <div>
                                                    {% if capacity.specific_date %}
                                                        ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà {{ capacity.specific_date|thai_date }}
                                                    {% elif capacity.day_of_week is not none %}
                                                        ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô {{ capacity.day_of_week|day_name_th_short }}
                                                    {% else %}
                                                        ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô
                                                    {% endif %}
                                                </div>
                                                {% if capacity.time_slot_start and capacity.time_slot_end %}
                                                    <div>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ {{ capacity.time_slot_start }} - {{ capacity.time_slot_end }}</div>
                                                {% endif %}
                                                {% if capacity.notes %}
                                                    <div class="text-xs text-gray-500">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: {{ capacity.notes }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="mt-4 lg:mt-0 flex items-center space-x-3">
                                            <form method="POST"
                                                  action="{{ url('availability.toggle_resource_capacity', template_id=selected_template.id, capacity_id=capacity.capacity_id) }}">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <input type="hidden" name="is_active" value="{{ 'on' if not capacity.is_active else 'off' }}">
                                                <button type="submit"
                                                        class="px-4 py-2 text-sm rounded-lg border transition-colors {% if capacity.is_active %}border-emerald-200 text-emerald-700 hover:bg-emerald-50{% else %}border-gray-200 text-gray-600 hover:bg-gray-100{% endif %}">
                                                    {% if capacity.is_active %}‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô{% else %}‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô{% endif %}
                                                </button>
                                            </form>
                                            <form method="POST"
                                                  action="{{ url('availability.delete_resource_capacity', template_id=selected_template.id, capacity_id=capacity.capacity_id) }}"
                                                  onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <button type="submit"
                                                        class="px-4 py-2 border border-red-200 text-red-600 rounded-lg hover:bg-red-50 transition-colors text-sm">
                                                    ‡∏•‡∏ö
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8 text-gray-500 bg-gray-50 border border-dashed border-gray-300 rounded-lg">
                            <p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>
                            <p class="text-xs mt-1 text-gray-400">‡πÉ‡∏ä‡πâ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</p>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-8 text-gray-500">
                        <p class="text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏</p>
                    </div>
                {% endif %}
            </div>

            <div class="bg-white rounded-xl shadow-sm border p-6" id="provider-leaves-card">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-4">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900">‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h2>
                        <p class="text-sm text-gray-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å</p>
                    </div>
                    {% if selected_template %}
                        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                            <select id="leave-provider-select"
                                    class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    {% if not provider_options %}disabled{% endif %}>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option>
                                {% for provider in provider_options %}
                                    <option value="{{ provider.id }}">{{ provider.name }}{% if provider.title %} ‚Ä¢ {{ provider.title }}{% endif %}</option>
                                {% endfor %}
                            </select>
                            <button type="button"
                                    class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm"
                                    onclick="openLeaveModal()"
                                    {% if not provider_options %}disabled{% endif %}>
                                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏•‡∏≤
                            </button>
                        </div>
                    {% endif %}
                </div>
                {% if selected_template %}
                    <div id="provider-leave-list" class="space-y-3"
                         data-template-id="{{ selected_template.id }}"
                         data-csrf="{{ csrf_token() }}">
                        <div class="text-sm text-gray-500 bg-gray-50 border border-dashed border-gray-300 rounded-lg p-4 text-center">
                            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-8 text-gray-500">
                        <p class="text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤</p>
                    </div>
                {% endif %}
            </div>

            {% if selected_template %}
            <div id="template-date-overrides" class="bg-white rounded-xl shadow-sm border p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900">‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</h2>
                        <p class="text-sm text-gray-600 mt-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏Å‡∏ï‡∏¥</p>
                    </div>
                </div>

                {% if template_overrides %}
                    <div class="space-y-3">
                        {% for override in template_overrides %}
                            <div class="override-item border rounded-lg p-4 bg-purple-50 border-purple-200">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-sm font-medium text-gray-700">üìÖ {{ override.date | thai_date }}</span>
                                    </div>
                                    <form method="POST" action="{{ url('availability.delete_date_override', override_id=override.id) }}" 
                                          style="display: inline;" 
                                          onsubmit="return confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ô‡∏µ‡πâ?')">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button type="submit" class="text-red-600 hover:text-red-800 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </form>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <span class="text-sm font-medium">
                                            {% if override.is_unavailable %}
                                                üö´ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
                                            {% else %}
                                                ‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div>
                                        {% if override.is_unavailable %}
                                            <div class="text-sm text-red-600">‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</div>
                                        {% else %}
                                            <div class="flex items-center space-x-2">
                                                <span class="text-sm font-mono">{{ override.custom_start_time or '' }}</span>
                                                <span class="text-gray-500">-</span>
                                                <span class="text-sm font-mono">{{ override.custom_end_time or '' }}</span>
                                            </div>
                                        {% endif %}
                                        {% if override.reason %}
                                            <div class="text-sm text-gray-600 mt-1">"{{ override.reason }}"</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-8 text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4v10a2 2 0 002 2h4a2 2 0 002-2V11"></path>
                        </svg>
                        <p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏ô‡∏µ‡πâ</p>
                        <p class="text-xs text-gray-400 mt-1">‡∏Å‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</p>
                    </div>
                {% endif %}
            </div>
            {% else %}
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <div class="text-center py-8 text-gray-500">
                    <p class="text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</p>
                </div>
            </div>
            {% endif %}

        </div>
    </div>
</div>

{% if selected_template %}
<!-- Provider Assignment Modal -->
<div id="provider-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center modal-overlay">
    <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4" onclick="event.stopPropagation();">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï</h3>
            <button onclick="closeModal('provider-modal')" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <form method="POST" action="{{ url('availability.add_template_provider', template_id=selected_template.id) }}" class="space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label>
                <select name="provider_id" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ --</option>
                    {% for provider in provider_options %}
                        <option value="{{ provider.id }}" {% if provider.id in assigned_ids %}disabled{% endif %}>
                            {{ provider.name }}{% if provider.title %} ‚Ä¢ {{ provider.title }}{% endif %}
                            {% if provider.id in assigned_ids %}(‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡πâ‡∏ß){% endif %}
                        </option>
                    {% endfor %}
                </select>
                {% if provider_options|length == 0 %}
                    <p class="mt-2 text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                {% endif %}
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <label class="flex items-center space-x-2">
                    <input type="checkbox" name="is_primary" value="on"
                           class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <span class="text-sm text-gray-700">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πá‡∏ô Primary</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="checkbox" name="can_auto_assign" value="on" checked
                           class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <span class="text-sm text-gray-700">‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
                </label>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (Priority)</label>
                <input type="number" name="priority" value="0" min="0" max="99"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                <p class="text-xs text-gray-500 mt-1">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏¢‡∏¥‡πà‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏¢‡∏¥‡πà‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏π‡∏á</p>
            </div>

            <div class="flex justify-end space-x-4 pt-4">
                <button type="button" onclick="closeModal('provider-modal')"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button type="submit"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                        {% if provider_options|length == 0 %}disabled{% endif %}>
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Provider Schedule Modal -->
<div id="schedule-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center modal-overlay">
    <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4" onclick="event.stopPropagation();">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900" id="schedule-modal-title">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>
            <button onclick="closeModal('schedule-modal')" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <form id="provider-schedule-form"
              method="POST"
              action="{{ url('availability.add_provider_schedule', template_id=selected_template.id) }}"
              class="space-y-4"
              data-create-action="{{ url('availability.add_provider_schedule', template_id=selected_template.id) }}"
              data-update-action-template="{{ url('availability.update_provider_schedule', template_id=selected_template.id, schedule_id=999999) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="schedule_id" id="schedule-id-input" value="">
            <input type="hidden" name="is_active" id="schedule-is-active-input" value="on">

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label>
                    <select name="provider_id" id="schedule-provider-select" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ --</option>
                        {% for provider in provider_options %}
                            <option value="{{ provider.id }}" {% if provider.id in scheduled_provider_ids %}disabled{% endif %}>
                                {{ provider.name }}{% if provider.title %} ‚Ä¢ {{ provider.title }}{% endif %}
                                {% if provider.id in scheduled_provider_ids %}(‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-500 mt-2">‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡∏≤‡∏£‡∏≤‡∏á</label>
                    <select name="schedule_type" id="schedule-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="regular">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥</option>
                        <option value="override">Override ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏¥‡∏à</option>
                        <option value="oncall">On-call / ‡πÄ‡∏ß‡∏£‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                    <input type="date" name="effective_date" id="schedule-effective-date" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                    <input type="date" name="end_date" id="schedule-end-date"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                    {% set day_names_modal = ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'] %}
                    {% for day in range(7) %}
                        <label class="flex items-center space-x-2 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2">
                            <input type="checkbox" name="days_of_week" value="{{ day }}"
                                   class="schedule-day-checkbox h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                            <span class="text-sm text-gray-700">{{ day_names_modal[day] }}</span>
                        </label>
                    {% endfor %}
                </div>
                <p class="text-xs text-gray-500 mt-2">‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</p>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏ñ‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï)</label>
                    <input type="time" name="custom_start_time" id="schedule-start-time"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                    <input type="time" name="custom_end_time" id="schedule-end-time"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                <textarea name="notes" id="schedule-notes" rows="3"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                          placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
            </div>

            <div class="flex justify-end space-x-4 pt-4">
                <button type="button" onclick="closeModal('schedule-modal')"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button type="submit" id="schedule-submit-button"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Capacity Modal -->
<div id="capacity-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center modal-overlay">
    <div class="bg-white rounded-xl p-6 max-w-xl w-full mx-4" onclick="event.stopPropagation();">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏</h3>
            <button onclick="closeModal('capacity-modal')" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <form method="POST" action="{{ url('availability.add_resource_capacity', template_id=selected_template.id) }}" class="space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á</label>
                    <input type="date" name="specific_date"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</label>
                    <select name="day_of_week"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="none">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ (‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) --</option>
                        {% set day_labels_modal = ['‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò', '‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå'] %}
                        {% for day in range(7) %}
                            <option value="{{ day }}">{{ day_labels_modal[day] }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <p class="text-xs text-gray-500">‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</p>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡πâ‡∏≠‡∏á / Slot ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</label>
                    <input type="number" name="available_rooms" value="1" min="1" max="99" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                    <input type="number" name="max_concurrent_appointments" min="1" max="99"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)</label>
                    <input type="time" name="time_slot_start"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                    <input type="time" name="time_slot_end"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
            </div>

            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                <textarea name="notes" rows="3"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                          placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ö‡∏£‡∏¥‡∏ö‡∏ó ‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á"></textarea>
                <label class="flex items-center space-x-2">
                    <input type="checkbox" name="is_active" value="on" checked
                           class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <span class="text-sm text-gray-700">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</span>
                </label>
            </div>

            <div class="flex justify-end space-x-4 pt-4">
                <button type="button" onclick="closeModal('capacity-modal')"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button type="submit"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Provider Leave Modal -->
<div id="leave-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center modal-overlay">
    <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4" onclick="event.stopPropagation();">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h3 class="text-lg font-semibold text-gray-900">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>
                <p class="text-sm text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡πâ: <span id="leave-modal-provider-label" class="font-medium text-gray-800"></span></p>
            </div>
            <button onclick="closeModal('leave-modal')" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <form method="POST" action="{{ url('availability.add_provider_leave', template_id=selected_template.id) }}" class="space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="provider_id" id="leave-modal-provider-id" value="">

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤</label>
                    <input type="date" name="start_date" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡∏≤</label>
                    <input type="date" name="end_date" required
                           class="w-full px-3 py-2 border.border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
                    <input type="text" name="leave_type"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                           placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô, ‡∏•‡∏≤‡∏Å‡∏¥‡∏à, ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                    <input type="text" name="approved_by"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                <input type="text" name="reason"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                       placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∑‡πà‡∏ô ‡πÜ">
            </div>

            <label class="flex items-center space-x-2">
                <input type="checkbox" name="is_approved" value="on"
                       class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                <span class="text-sm text-gray-700">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>
            </label>

            <div class="flex justify-end space-x-4 pt-4">
                <button type="button" onclick="closeModal('leave-modal')"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button type="submit"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏≤
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<!-- Date Override Modal -->
<div id="date-override-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</h3>
            <button onclick="hideOverrideForm()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form id="date-override-form" method="POST" action="{{ url('availability.create_date_override') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="template_id" id="modal-template-id" value="">
            <input type="hidden" name="scope" id="modal-scope" value="global">
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="date" name="date" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                    <div class="space-y-2">
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="override_type" value="custom" checked 
                                   class="text-purple-600" onchange="toggleTimeInputs()">
                            <span class="text-sm">‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="override_type" value="unavailable" 
                                   class="text-purple-600" onchange="toggleTimeInputs()">
                            <span class="text-sm">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</span>
                        </label>
                    </div>
                </div>
                
                <div id="time-inputs">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©</label>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="time" name="custom_start_time" 
                               class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <input type="time" name="custom_end_time" 
                               class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                    <input type="text" name="reason" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                           placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå">
                </div>
            </div>
            
            <div class="flex justify-end space-x-4 mt-6">
                <button type="button" onclick="hideOverrideForm()" 
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const templateId = {{ selected_template.id if selected_template else 'null' }};
    const assignedProviderIds = {{ assigned_ids|default([], true)|tojson }};
    const providerOptionsData = {{ provider_options|default([], true)|tojson }};
    const providerLookup = {};
    providerOptionsData.forEach(provider => {
        if (provider && provider.id !== undefined) {
            providerLookup[String(provider.id)] = provider;
        }
    });
    const csrfTokenValue = "{{ csrf_token() }}";
    const currentPageUrl = new URL(window.location.href);
    const subdomainParam = currentPageUrl.searchParams.get('subdomain');
    const templateScheduleMap = {{ schedule_map|default({}, true)|tojson }};
    const templateDefaultDayList = {{ selected_template.days|default([], true)|tojson }};
    const mapDayValues = Object.keys(templateScheduleMap || {})
        .filter(key => Array.isArray(templateScheduleMap[key]) && (templateScheduleMap[key] || []).length > 0)
        .map(key => {
            const parsed = parseInt(key, 10);
            return Number.isNaN(parsed) ? null : parsed;
        })
        .filter(day => day !== null);
    const fallbackDayValues = Array.isArray(templateDefaultDayList)
        ? templateDefaultDayList.filter(day => typeof day === 'number' && !Number.isNaN(day))
        : [];
    const defaultScheduleDays = (mapDayValues.length > 0 ? mapDayValues : fallbackDayValues).filter((value, index, array) => array.indexOf(value) === index);
    const scheduleModalElement = document.getElementById('schedule-modal');
    const scheduleForm = document.getElementById('provider-schedule-form');
    const scheduleProviderSelect = document.getElementById('schedule-provider-select');
    const scheduleTypeSelect = document.getElementById('schedule-type');
    const scheduleEffectiveInput = document.getElementById('schedule-effective-date');
    const scheduleEndInput = document.getElementById('schedule-end-date');
    const scheduleStartInput = document.getElementById('schedule-start-time');
    const scheduleEndTimeInput = document.getElementById('schedule-end-time');
    const scheduleNotesInput = document.getElementById('schedule-notes');
    const scheduleDayCheckboxes = scheduleModalElement ? Array.from(scheduleModalElement.querySelectorAll('.schedule-day-checkbox')) : [];
    const scheduleModalTitle = document.getElementById('schedule-modal-title');
    const scheduleSubmitButton = document.getElementById('schedule-submit-button');
    const scheduleIdInput = document.getElementById('schedule-id-input');
    const scheduleIsActiveInput = document.getElementById('schedule-is-active-input');
    let lastEditedProviderOption = null;
    let lastEditedProviderWasDisabled = false;

    function deleteTemplate(event, templateId) {
        event.stopPropagation();
        const deleteButton = event.currentTarget;
        const templateName = deleteButton.dataset.templateName || '';

        // ‡∏ñ‡∏≤‡∏° confirm
        if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï "${templateName}"?\n\n‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏´‡∏≤‡∏Å Event Type ‡πÉ‡∏î‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`)) {
            return;
        }
        
        const originalHTML = deleteButton.innerHTML;
        deleteButton.disabled = true;
        deleteButton.innerHTML = '<span class="animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...</span>';
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á form ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ö‡∏ö dynamic (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)
        const form = document.createElement('form');
        form.method = 'POST';
        form.style.display = 'none';

        const actionUrl = new URL(`/settings/availability/template/${templateId}/delete`, window.location.origin);
        if (subdomainParam) {
            actionUrl.searchParams.set('subdomain', subdomainParam);
        }
        form.action = actionUrl.toString();
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° CSRF token (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Flask security)
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrf_token';
        csrfToken.value = csrfTokenValue;
        form.appendChild(csrfToken);
        
        // ‡πÄ‡∏Å‡πá‡∏ö URL ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡πá‡∏Ñ
        const originalUrl = window.location.href;
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° error handling ‡∏´‡∏≤‡∏Å form submit ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        setTimeout(() => {
            // ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
            if (window.location.href === originalUrl) {
                deleteButton.disabled = false;
                deleteButton.innerHTML = originalHTML;
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ flash message ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const flashMessages = document.querySelectorAll('[role="alert"]');
                if (flashMessages.length === 0) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö');
                }
            }
        }, 3000); // ‡∏£‡∏≠ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° form ‡∏•‡∏á‡πÉ‡∏ô body ‡πÅ‡∏•‡∏∞ submit
        document.body.appendChild(form);
        form.submit();
    }
    
    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å template - ‡πÉ‡∏ä‡πâ server-side rendering
    function selectTemplate(templateId) {
        // Reload page with selected template parameter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ server render ‡πÉ‡∏´‡∏°‡πà
        const url = new URL(window.location);
        url.searchParams.set('selected_template', templateId);
        
        // ‡πÄ‡∏Å‡πá‡∏ö subdomain parameter ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢
        const subdomain = url.searchParams.get('subdomain');
        if (subdomain) {
            url.searchParams.set('subdomain', subdomain);
        }
        
        window.location.href = url.toString();
    }
    
    // ‡πÇ‡∏´‡∏•‡∏î template-specific overrides
    async function loadTemplateOverrides(templateId) {
        try {
            const endpoint = `/settings/api/template/${templateId}/overrides${subdomainParam ? `?subdomain=${encodeURIComponent(subdomainParam)}` : ''}`;
            const response = await fetch(endpoint);
            const data = await response.json();
            
            if (response.ok) {
                const content = document.getElementById('template-overrides-content');
                const overrides = data.date_overrides || [];
                
                if (overrides.length > 0) {
                    let overridesHtml = '<div class="space-y-3">';
                    
                    overrides.forEach(override => {
                        overridesHtml += `
                            <div class="override-item border rounded-lg p-4 bg-purple-50 border-purple-200">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-sm font-medium text-gray-700">üìÖ ${override.date}</span>
                                        <span class="text-xs bg-purple-200 text-purple-700 px-2 py-1 rounded-full">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï</span>
                                    </div>
                                    <form method="POST" action="/settings/availability/date-override/${override.id}/delete" 
                                          style="display: inline;" 
                                          onsubmit="return confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ô‡∏µ‡πâ?')">
                                        <input type="hidden" name="csrf_token" value="${csrfTokenValue}">
                                        <button type="submit" class="text-red-600 hover:text-red-800 transition-colors">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </form>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <span class="text-sm font-medium">${override.is_unavailable ? 'üö´ ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î' : '‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏©'}</span>
                                    </div>
                                    <div>
                                        ${override.is_unavailable ? 
                                            '<div class="text-sm text-red-600">‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</div>' :
                                            `<div class="flex items-center space-x-2">
                                                <span class="text-sm font-mono">${override.custom_start_time || ''}</span>
                                                <span class="text-gray-500">-</span>
                                                <span class="text-sm font-mono">${override.custom_end_time || ''}</span>
                                            </div>`
                                        }
                                        ${override.reason ? `<div class="text-sm text-gray-600 mt-1">"${override.reason}"</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    overridesHtml += '</div>';
                    content.innerHTML = overridesHtml;
                } else {
                    content.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4v10a2 2 0 002 2h4a2 2 0 002-2V11"></path>
                            </svg>
                            <p class="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏ô‡∏µ‡πâ</p>
                        </div>
                    `;
                }
            }
        } catch (error) {
            console.error('Error loading template overrides:', error);
        }
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    function showGlobalOverrideForm() {
        document.getElementById('modal-template-id').value = '';
        document.getElementById('modal-scope').value = 'global';
        document.getElementById('date-override-modal').classList.remove('hidden');
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï
    function showTemplateOverrideForm() {
        if (templateId) {
            document.getElementById('modal-template-id').value = templateId;
            document.getElementById('modal-scope').value = 'template';
            document.getElementById('date-override-modal').classList.remove('hidden');
        } else {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏Å‡πà‡∏≠‡∏ô');
        }
    }
    
    // ‡∏ã‡πà‡∏≠‡∏ô form
    function hideOverrideForm() {
        document.getElementById('date-override-modal').classList.add('hidden');
        document.getElementById('date-override-form').reset();
    }
    
    // Toggle time inputs ‡∏ï‡∏≤‡∏° override type
    function toggleTimeInputs() {
        const overrideType = document.querySelector('input[name="override_type"]:checked').value;
        const timeInputs = document.getElementById('time-inputs');
        
        if (overrideType === 'unavailable') {
            timeInputs.style.display = 'none';
            // Clear time values
            document.querySelector('input[name="custom_start_time"]').value = '';
            document.querySelector('input[name="custom_end_time"]').value = '';
        } else {
            timeInputs.style.display = 'block';
        }
    }

    function setScheduleDays(days) {
        if (!scheduleDayCheckboxes.length) {
            return;
        }
        const allowedValues = Array.isArray(days) ? new Set(days.map(day => String(day))) : new Set();
        scheduleDayCheckboxes.forEach(checkbox => {
            checkbox.checked = allowedValues.size > 0 ? allowedValues.has(checkbox.value) : false;
        });
    }

    function resetScheduleForm() {
        if (!scheduleForm) {
            return;
        }
        scheduleForm.reset();
        if (scheduleIdInput) {
            scheduleIdInput.value = '';
        }
        if (scheduleSubmitButton) {
            scheduleSubmitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
        }
        if (scheduleModalTitle) {
            scheduleModalTitle.textContent = '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£';
        }
        if (scheduleForm.dataset && scheduleForm.dataset.createAction) {
            scheduleForm.action = scheduleForm.dataset.createAction;
        }
        if (scheduleEffectiveInput) {
            scheduleEffectiveInput.value = '';
        }
        if (scheduleEndInput) {
            scheduleEndInput.value = '';
        }
        if (scheduleStartInput) {
            scheduleStartInput.value = '';
        }
        if (scheduleEndTimeInput) {
            scheduleEndTimeInput.value = '';
        }
        if (scheduleNotesInput) {
            scheduleNotesInput.value = '';
        }
        if (scheduleIsActiveInput) {
            scheduleIsActiveInput.value = 'on';
        }
        if (scheduleProviderSelect) {
            scheduleProviderSelect.disabled = false;
            if (scheduleProviderSelect.options.length > 0) {
                scheduleProviderSelect.value = '';
            }
        }
        if (lastEditedProviderOption) {
            lastEditedProviderOption.disabled = lastEditedProviderWasDisabled;
            lastEditedProviderOption = null;
        }
        lastEditedProviderWasDisabled = false;
        setScheduleDays(defaultScheduleDays);
    }

    function openScheduleModalForCreate() {
        if (!scheduleForm) {
            return;
        }
        resetScheduleForm();
        openModal('schedule-modal');
    }

    function openScheduleModalForEdit(trigger) {
        if (!scheduleForm || !trigger) {
            return;
        }
        const scheduleId = trigger.dataset.scheduleId;
        if (!scheduleId) {
            return;
        }
        resetScheduleForm();
        if (scheduleForm.dataset && scheduleForm.dataset.updateActionTemplate) {
            const updateUrl = scheduleForm.dataset.updateActionTemplate.replace('999999', scheduleId);
            scheduleForm.action = updateUrl;
        }
        if (scheduleIdInput) {
            scheduleIdInput.value = scheduleId;
        }
        if (scheduleModalTitle) {
            scheduleModalTitle.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£';
        }
        if (scheduleSubmitButton) {
            scheduleSubmitButton.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
        }
        const providerId = trigger.dataset.providerId || '';
        if (scheduleProviderSelect) {
            if (providerId) {
                const option = scheduleProviderSelect.querySelector(`option[value="${providerId}"]`);
                if (option) {
                    lastEditedProviderWasDisabled = option.disabled;
                    lastEditedProviderOption = option;
                    option.disabled = false;
                }
                scheduleProviderSelect.value = providerId;
            }
            scheduleProviderSelect.disabled = true;
        }
        if (scheduleTypeSelect && trigger.dataset.scheduleType) {
            scheduleTypeSelect.value = trigger.dataset.scheduleType;
        }
        if (scheduleEffectiveInput && trigger.dataset.effectiveDate) {
            scheduleEffectiveInput.value = trigger.dataset.effectiveDate;
        }
        if (scheduleEndInput) {
            scheduleEndInput.value = trigger.dataset.endDate || '';
        }
        if (scheduleStartInput) {
            scheduleStartInput.value = trigger.dataset.startTime || '';
        }
        if (scheduleEndTimeInput) {
            scheduleEndTimeInput.value = trigger.dataset.endTime || '';
        }
        if (scheduleNotesInput) {
            scheduleNotesInput.value = trigger.dataset.notes || '';
        }
        if (scheduleIsActiveInput) {
            scheduleIsActiveInput.value = trigger.dataset.isActive === 'false' ? 'off' : 'on';
        }
        const dayValuesRaw = trigger.dataset.days || '';
        if (dayValuesRaw) {
            const parsedDays = dayValuesRaw.split(',')
                .map(value => parseInt(value.trim(), 10))
                .filter(num => !Number.isNaN(num));
            setScheduleDays(parsedDays);
        } else {
            setScheduleDays([]);
        }
        openModal('schedule-modal');
    }

    function openModal(id) {
        const modal = document.getElementById(id);
        if (!modal) return;
        modal.classList.remove('hidden');
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        if (!modal) return;
        modal.classList.add('hidden');
        if (id === 'schedule-modal') {
            resetScheduleForm();
        } else {
            const form = modal.querySelector('form');
            if (form) {
                form.reset();
            }
        }
        if (id === 'leave-modal') {
            const label = document.getElementById('leave-modal-provider-label');
            if (label) {
                label.textContent = '';
            }
        }
    }

    function renderDefaultLeaveMessage() {
        const container = document.getElementById('provider-leave-list');
        if (!container) return;
        container.innerHTML = '<div class="text-sm text-gray-500 bg-gray-50 border border-dashed border-gray-300 rounded-lg p-4 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤</div>';
    }

    function openLeaveModal() {
        const select = document.getElementById('leave-provider-select');
        if (!select) return;
        const providerId = select.value;
        if (!providerId) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô');
            return;
        }
        const provider = providerLookup[String(providerId)];
        const label = document.getElementById('leave-modal-provider-label');
        if (label) {
            label.textContent = provider ? provider.name : '';
        }
        const input = document.getElementById('leave-modal-provider-id');
        if (input) {
            input.value = providerId;
        }
        openModal('leave-modal');
    }

    const htmlEscapes = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
    };

    function escapeHtml(value) {
        if (value === null || value === undefined) {
            return '';
        }
        return String(value).replace(/[&<>"']/g, match => htmlEscapes[match] || match);
    }

    function formatDate(value) {
        if (!value) return '-';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
            return escapeHtml(value);
        }
        return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function renderProviderLeaves(providerId, leaves) {
        const container = document.getElementById('provider-leave-list');
        if (!container) return;
        const provider = providerLookup[String(providerId)];
        const providerName = provider ? provider.name : '‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£';

        if (!leaves || leaves.length === 0) {
            container.innerHTML = `
                <div class="text-sm font-semibold text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Ç‡∏≠‡∏á ${escapeHtml(providerName)}</div>
                <div class="text-sm text-gray-500 bg-gray-50 border border-dashed border-gray-300 rounded-lg p-4 text-center">
                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
                </div>
            `;
            return;
        }

        let itemsHtml = '';
        leaves.forEach(leave => {
            const start = formatDate(leave.start_date);
            const end = formatDate(leave.end_date);
            let deleteAction = '#';
            if (templateId) {
                const deleteUrl = new URL(`/settings/availability/template/${templateId}/provider-leaves/${providerId}/${leave.leave_id}/delete`, window.location.origin);
                if (subdomainParam) {
                    deleteUrl.searchParams.set('subdomain', subdomainParam);
                }
                deleteAction = deleteUrl.toString();
            }
            itemsHtml += `
                <div class="border border-gray-200 rounded-lg p-4 bg-white shadow-sm">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                        <div>
                            <div class="text-sm font-semibold text-gray-900">${start} - ${end}</div>
                            <div class="text-xs text-gray-600 mt-1">${escapeHtml(leave.leave_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó')}</div>
                            ${leave.reason ? `<div class="text-xs text-gray-500 mt-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${escapeHtml(leave.reason)}</div>` : ''}
                            ${leave.approved_by ? `<div class="text-xs text-gray-400 mt-1">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ${escapeHtml(leave.approved_by)}</div>` : ''}
                            <span class="inline-flex mt-2 px-2 py-0.5 rounded-full ${leave.is_approved ? 'bg-emerald-100 text-emerald-700' : 'bg-yellow-100 text-yellow-700'} text-xs">
                                ${leave.is_approved ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'}
                            </span>
                        </div>
                        <form method="POST" action="${deleteAction}" class="mt-4 sm:mt-0" onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')">
                            <input type="hidden" name="csrf_token" value="${csrfTokenValue}">
                            <button type="submit" class="px-3 py-1 border border-red-200 text-red-600 rounded-lg hover:bg-red-50 transition-colors text-sm">
                                ‡∏•‡∏ö
                            </button>
                        </form>
                    </div>
                </div>
            `;
        });

        container.innerHTML = `
            <div class="text-sm font-semibold text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Ç‡∏≠‡∏á ${escapeHtml(providerName)}</div>
            <div class="space-y-3">${itemsHtml}</div>
        `;
    }

    async function fetchProviderLeaves(providerId) {
        const container = document.getElementById('provider-leave-list');
        if (!container) return;
        container.innerHTML = '<div class="text-sm text-gray-500 bg-gray-50 border border-dashed border-gray-300 rounded-lg p-4 text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';
        try {
            const endpoint = `/settings/api/providers/${providerId}/leaves${subdomainParam ? `?subdomain=${encodeURIComponent(subdomainParam)}` : ''}`;
            const response = await fetch(endpoint);
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ');
            }
            renderProviderLeaves(providerId, data.leaves || []);
        } catch (error) {
            container.innerHTML = `<div class="text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg p-4 text-center">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${escapeHtml(error.message)}</div>`;
        }
    }
    
    // Initialize
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.openLeaveModal = openLeaveModal;
    window.openScheduleModalForCreate = openScheduleModalForCreate;
    window.openScheduleModalForEdit = openScheduleModalForEdit;

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('input[name="override_type"]').forEach(radio => {
            radio.addEventListener('change', toggleTimeInputs);
        });

        if (scheduleForm) {
            resetScheduleForm();
        }

        const leaveSelect = document.getElementById('leave-provider-select');
        if (leaveSelect) {
            leaveSelect.addEventListener('change', () => {
                const providerId = leaveSelect.value;
                if (providerId) {
                    fetchProviderLeaves(providerId);
                } else {
                    renderDefaultLeaveMessage();
                }
            });

            if (templateId && Array.isArray(assignedProviderIds) && assignedProviderIds.length > 0) {
                const defaultId = String(assignedProviderIds[0]);
                const options = Array.from(leaveSelect.options || []);
                if (options.some(option => option.value === defaultId)) {
                    leaveSelect.value = defaultId;
                    fetchProviderLeaves(defaultId);
                }
            }
        }

        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeModal(modal.id);
                }
            });
        });
    });
</script>
{% endblock %}