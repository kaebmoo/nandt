<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เลื่อนนัดหมาย - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .slot-button { transition: all 0.15s ease; }
        .slot-button:hover { transform: translateY(-1px); }
        .slot-button.selected { border-color: #4f46e5; background-color: #eef2ff; color: #312e81; }
        .slot-button.disabled { cursor: not-allowed; opacity: 0.5; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-5xl mx-auto py-8 px-4">
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">เลื่อนนัดหมาย</h1>
                    <p class="text-sm text-gray-500 mt-1">เลือกวันและเวลาที่พร้อมให้บริการตามเทมเพลตและความพร้อมของผู้ให้บริการ</p>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-sm text-yellow-800 w-full md:w-auto">
                    <div class="font-semibold mb-1">นัดหมายปัจจุบัน</div>
                    <div>รหัส: {{ appointment.booking_reference }}</div>
                    <div>ชื่อผู้รับบริการ: {{ appointment.guest_name }}</div>
                    <div>วันเวลาเดิม: {{ appointment.start_time.strftime('%d/%m/%Y %H:%M') }}</div>
                </div>
            </div>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages mb-6 space-y-3"> {# เพิ่ม mb-6 เพื่อให้มีระยะห่างกับฟอร์ม #}
                        {% for category, message in messages %}
                            {# 
                                ปรับแก้ CSS ให้เข้ากับ Tailwind CSS
                                - warning (สีเหลือง)
                                - error (สีแดง)
                                - success (สีเขียว)
                                - info (สีฟ้า)
                            #}
                            {% set alert_classes = {
                                'warning': 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700',
                                'error': 'bg-red-100 border-l-4 border-red-500 text-red-700',
                                'success': 'bg-green-100 border-l-4 border-green-500 text-green-700',
                                'info': 'bg-blue-100 border-l-4 border-blue-500 text-blue-700'
                            } %}
                            <div class="{{ alert_classes.get(category, alert_classes['info']) }} p-4" role="alert">
                                <p>{{ message }}</p>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}
            <form method="POST" action="" class="space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="new_time" id="new-time-input" value="">

                {% if requires_provider_assignment %}
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <label for="provider-select" class="block text-sm font-medium text-purple-900 mb-2">
                            เลือกผู้ให้บริการที่จะทำการเลื่อนนัด <span class="text-red-500">*</span>
                        </label>
                        {% if provider_options %}
                            <select id="provider-select" name="provider_id"
                                    class="w-full px-3 py-2 border border-purple-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">ไม่ระบุ - ให้ระบบเลือกให้</option>
                                {% for provider in provider_options %}
                                    <option value="{{ provider.id }}" {% if appointment.provider_id == provider.id %}selected{% endif %}>
                                        {{ provider.name }}{% if provider.title %} • {{ provider.title }}{% endif %}{% if not provider.is_active %} (ปิดใช้งาน){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                            <p class="text-xs text-purple-700 mt-2">ระบบจะแสดงเฉพาะเวลาที่ผู้ให้บริการที่เลือกสามารถรับนัดได้ หากไม่เลือก ระบบจะกระจายให้อัตโนมัติ</p>
                        {% else %}
                            <p class="text-sm text-red-600">ยังไม่มีผู้ให้บริการที่ผูกกับเทมเพลตนี้ กรุณาเพิ่มผู้ให้บริการก่อนทำการเลื่อนนัด</p>
                        {% endif %}
                    </div>
                {% endif %}

                <div class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">เลือกวันที่ต้องการเลื่อน <span class="text-red-500">*</span></label>
                            <input type="date" id="date-input" name="new_date" value="{{ appointment.start_time.strftime('%Y-%m-%d') }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>

                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-sm space-y-2">
                            <div class="font-semibold text-gray-800">คำแนะนำ</div>
                            <ul class="list-disc list-inside text-gray-600 space-y-1">
                                <li>ระบบจะแสดงเฉพาะเวลาที่เปิดจองตามเทมเพลตและยังมีความจุเหลือ</li>
                                <li>สีเทาหมายถึงช่วงเวลาที่ไม่ว่างหรือถูกปิดด้วยวันหยุด/เงื่อนไขเฉพาะ</li>
                                <li>ไม่สามารถเลือกเวลานัดเดิมซ้ำได้</li>
                            </ul>
                        </div>

                        <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 text-sm text-blue-800" id="selection-summary" hidden>
                            <div class="font-semibold mb-1">เวลาที่เลือก</div>
                            <div id="selection-details"></div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-semibold text-gray-900">ช่วงเวลาที่พร้อมให้บริการ</h2>
                            <button type="button" id="refresh-button"
                                    class="text-sm text-purple-600 hover:text-purple-800">รีเฟรช</button>
                        </div>
                        <div id="availability-notice" class="text-sm text-gray-500"></div>
                        <div id="slots-container" class="grid sm:grid-cols-2 gap-3">
                            <div class="text-sm text-gray-400">โปรดเลือกวันที่เพื่อโหลดช่วงเวลาที่พร้อมใช้งาน</div>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">เหตุผลในการเลื่อน <span class="text-red-500">*</span></label>
                    <textarea name="reason" rows="3" required
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                              placeholder="ระบุเหตุผล เช่น ผู้ป่วยติดธุระ / ประชุมทีม / ย้ายห้องตรวจ"></textarea>
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <a href="{{ url('main.dashboard', subdomain=subdomain) }}"
                       class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        กลับไปหน้าหลัก
                    </a>
                    <button type="submit" id="submit-button"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        ยืนยันการเลื่อน
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const availabilityEndpoint = "{{ url('main.admin_reschedule_availability', appointment_id=appointment.id, subdomain=subdomain) }}";
        const dateInput = document.getElementById('date-input');
        const providerSelect = document.getElementById('provider-select');
        const slotsContainer = document.getElementById('slots-container');
        const availabilityNotice = document.getElementById('availability-notice');
        const timeInput = document.getElementById('new-time-input');
        const submitButton = document.getElementById('submit-button');
        const selectionSummary = document.getElementById('selection-summary');
        const selectionDetails = document.getElementById('selection-details');
        const refreshButton = document.getElementById('refresh-button');

        const requiresProvider = {{ 'true' if requires_provider_assignment else 'false' }};

        function formatTimeLabel(timeStr) {
            const [hour, minute] = timeStr.split(':');
            return `${hour}:${minute}`;
        }

        function clearSelection() {
            timeInput.value = '';
            submitButton.disabled = true;
            selectionSummary.hidden = true;
            document.querySelectorAll('.slot-button.selected').forEach(btn => btn.classList.remove('selected'));
        }

        function renderSlots(data) {
            const { slots, message } = data;

            slotsContainer.innerHTML = '';

            if (message) {
                availabilityNotice.textContent = message;
                availabilityNotice.className = 'text-sm text-amber-600';
            } else {
                availabilityNotice.textContent = '';
                availabilityNotice.className = 'text-sm text-gray-500';
            }

            const availableSlots = slots.filter(slot => slot.available);

            if (slots.length === 0) {
                slotsContainer.innerHTML = '<div class="text-sm text-red-500">ไม่มีช่วงเวลาที่เปิดให้บริการในวันนี้</div>';
                return;
            }

            slots.forEach(slot => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'slot-button px-3 py-2 border rounded-lg text-sm flex flex-col text-left';
                button.dataset.time = slot.time;

                const timeLabel = document.createElement('span');
                timeLabel.className = 'font-semibold';
                timeLabel.textContent = formatTimeLabel(slot.time);

                const statusLabel = document.createElement('span');
                statusLabel.className = 'text-xs mt-1';

                if (!slot.available) {
                    button.classList.add('disabled', 'border-gray-200', 'bg-gray-100', 'text-gray-400');
                    button.disabled = true;

                    if (slot.unavailable_reason === 'current_slot') {
                        statusLabel.textContent = 'เวลานัดปัจจุบัน';
                    } else if (slot.unavailable_reason === 'fully_booked') {
                        statusLabel.textContent = 'เต็มแล้ว';
                    } else if (slot.unavailable_reason === 'no_provider') {
                        statusLabel.textContent = 'ไม่มีผู้ให้บริการว่าง';
                    } else if (slot.unavailable_reason === 'slot_too_soon') {
                        statusLabel.textContent = 'ใกล้เวลานัดเกินไป';
                    } else if (slot.unavailable_reason === 'template_override') {
                        statusLabel.textContent = 'ปิดให้บริการ';
                    } else {
                        statusLabel.textContent = slot.unavailable_reason ? slot.unavailable_reason : 'ไม่สามารถเลือกได้';
                    }
                } else {
                    button.classList.add('border-gray-300', 'hover:border-purple-400', 'hover:bg-purple-50');
                    statusLabel.classList.add('text-xs', 'text-gray-500');
                    statusLabel.textContent = slot.remaining_slots ? `เหลือ ${slot.remaining_slots} ช่อง` : 'พร้อมให้จอง';

                    button.addEventListener('click', () => {
                        document.querySelectorAll('.slot-button.selected').forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected');
                        timeInput.value = slot.time;
                        submitButton.disabled = false;
                        selectionSummary.hidden = false;
                        selectionDetails.textContent = `วันที่ ${new Date(dateInput.value).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })} เวลา ${formatTimeLabel(slot.time)}`;
                    });
                }

                button.appendChild(timeLabel);
                button.appendChild(statusLabel);
                slotsContainer.appendChild(button);
            });

            if (availableSlots.length === 0) {
                const alert = document.createElement('div');
                alert.className = 'text-sm text-red-500 mt-2';
                alert.textContent = 'ไม่มีช่วงเวลาที่พร้อมให้บริการสำหรับวันที่เลือก';
                slotsContainer.appendChild(alert);
            }
        }

        async function loadAvailability() {
            clearSelection();

            const selectedDate = dateInput.value;
            if (!selectedDate) {
                slotsContainer.innerHTML = '<div class="text-sm text-gray-400">โปรดเลือกวันที่</div>';
                return;
            }

            const params = new URLSearchParams({ date: selectedDate });
            if (requiresProvider && providerSelect && providerSelect.value) {
                params.append('provider_id', providerSelect.value);
            }

            slotsContainer.innerHTML = '<div class="text-sm text-gray-500">กำลังโหลดข้อมูล...</div>';

            try {
                // ตรวจสอบว่า URL มี ? อยู่แล้วหรือไม่
                const separator = availabilityEndpoint.includes('?') ? '&' : '?';
                const response = await fetch(`${availabilityEndpoint}${separator}${params.toString()}`);
                const data = await response.json();

                if (!response.ok) {
                    slotsContainer.innerHTML = `<div class="text-sm text-red-500">${data.error || 'ไม่สามารถโหลดข้อมูลได้'}</div>`;
                    return;
                }

                renderSlots(data);
            } catch (error) {
                console.error('Error loading availability:', error);
                slotsContainer.innerHTML = '<div class="text-sm text-red-500">ไม่สามารถโหลดข้อมูลได้</div>';
            }
        }

        if (dateInput) {
            dateInput.addEventListener('change', () => {
                loadAvailability();
            });
        }

        if (refreshButton) {
            refreshButton.addEventListener('click', () => {
                loadAvailability();
            });
        }

        if (providerSelect) {
            providerSelect.addEventListener('change', () => {
                loadAvailability();
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAvailability();
        });
    </script>
</body>
</html>